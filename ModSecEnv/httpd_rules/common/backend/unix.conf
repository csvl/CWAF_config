# Rules for Unix
# ---------------------------------------------------------------
# Range: 2001200-2001299 (moved from common)
# Range: 4003100-4003199

# Shell expansion
DefineStr linuxShellVarDecode    "~{htmlDecode_},msg:'Possible Linux environment variable'"
DefineStr linuxShellVarDecodeTag "tag:BackendOS,tag:OSShell,tag:Command,msg:'Bash shell expansion'"

<Macro BackendOSUnix>
 # Disable warning about OS
 Use SecRuleRemoveByID 1000103
 
 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByFullTag BackendOS
 
 Use SecRuleArgsCookies     "/home/"  2001201,tag:BackendOS,tag:OSShell,tag:Slash,tag:PATH,tag:SHORT "t:~{shellDecodeUnix}"
 Use SecRulePathEverywhere  "~/"      2001202,tag:BackendOS,tag:OSShell,tag:Slash,tag:tilde          "t:~{shellDecodeUnix}"
 #Use SecRulePathEverywhere  "~[a-z0-9-_]*/"    2001203,tag:BackendOS,tag:OSShell,tag:OSShell,tag:PATH,tag:Slash "t:~{shellDecodeUnix}"
 #Use SecRulePathEverywhere  "/~(root|ftp|bin|nobody|named|guest|logs|sshd)/"  2001216,tag:BackendOS,tag:OSShell,tag:PATH,tag:Slash "t:~{shellDecodeUnix}"
 #Use SecRulePathEverywhere  "etc/\W*passwd"  2001204,tag:BackendOS,tag:OSShell,tag:PATH,tag:Slash "t:~{shellDecodeUnix}"
 
 Use SecRulePathEverywhere "/(?:conf|local|system)(?:/|$)"                    2001209,tag:BackendOS,tag:OSShell,tag:Slash,tag:PATH,tag:SHORT "t:~{shellDecodeUnix}"
 Use SecRulePathEverywhere "(?<![a-z0-9])/(?:dev|etc|opt|root|tmp|usr)/"      4003116,tag:BackendOS,tag:OSShell,tag:Slash,tag:PATH,tag:SHORT "t:~{shellDecodeUnix}"
 Use SecRulePathEverywhere "/(?:s?bin|boot|httpd|kernel|proc|sys|var)(?:/|$)" 4003117,tag:BackendOS,tag:OSShell,tag:Slash,tag:PATH,tag:SHORT "t:~{shellDecodeUnix}"
 #Use SecRulePathEverywhere "/(?:bash)\b"                                      4003121,tag:BackendOS,tag:OSShell,tag:Slash,tag:PATH,tag:SHORT "t:~{shellDecodeUnix}"

 Use SecRuleArgsCookies  "~{UnixCmdDelim}([cks]|ba)?sh\s+[-/]"                4003144,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeUnix}"
 Use SecRuleArgsCookies  "~{UnixCmdDelim}exec\b"                              4003125,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeUnix}"
 Use SecRuleArgsCookies  "~{UnixCmdDelim}(?:curl|[px]kill|killall|mkdir|netcat|rcmd|sendmail|ssh|traceroute|wget)\s" 4003126,tag:BackendOS,tag:SHORT,tag:PossibleName,tag:Command,tag:CmdDelim "t:~{shellDecodeUnix}"
 # curl/wget followed by: http(s) ftp(s) scp sftp (fqdn without scheme won't be catched)
 Use SkipAfterOnSuccess 4003126,tag:security,tag:BackendOS,tag:SHORT,tag:PossibleName,tag:Command,tag:CmdDelim AfterCurl
  Use SecRuleArgsCookies "~{UnixCmdDelim}(?:curl|wget)\s.*(?:(?:f|ht)tps?|s(?:c|ft)p)://"           4003133,tag:BackendOS,tag:Command,tag:CmdDelim,tag:Slash  "t:~{shellDecodeUnix}"
 Use SecMarker AfterCurl,tag:security,tag:BackendOS,tag:SHORT,tag:PossibleName,tag:Command,tag:CmdDelim
 Use SecRuleHeuristicArgsCookies "~{UnixCmdDelim}r(?:cp|sh)\s"            4003127,tag:BackendOS,tag:SHORT,tag:Command,tag:CmdDelim 2 "~{shellDecodeUnix}" "Possible Command Injection Attack"
 Use SecRuleArgsCookies "~{UnixCmdDelim}(?:ncftp|tclsh8?|whoami)\b"       4003128,tag:BackendOS,tag:SHORT,tag:Command,tag:CmdDelim "t:~{shellDecodeUnix}"
 Use SecRuleArgsCookies "~{UnixCmdDelim}perl\s.*-e\s"                     4003129,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeUnix}"
 Use SecRuleArgsCookies "~{UnixCmdDelim}rm\s+--?[a-zA-Z]"                 4003130,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeUnix}"
 Use SecRuleHeuristicArgsCookies "~{UnixCmdDelim}nc\s+-"                  4003131,tag:BackendOS,tag:SHORT,tag:Command,tag:CmdDelim 2 "~{shellDecodeUnix}" "Possible Command Injection Attack"
 Use SecRuleHeuristicArgsCookies "~{UnixCmdDelim}kill\s+(?:-[a-z0-9-]|[0-9-]{3})" 4003132,tag:BackendOS,tag:SHORT,tag:Command,tag:CmdDelim 3 "~{shellDecodeUnix}" "Possible Command Injection Attack"
 Use SecRuleArgsCookies "~{UnixCmdDelim}(?:passwd|elinks|rexec|g[+][+])\s" 4003134,tag:BackendOS,tag:Command,tag:CmdDelim,tag:SHORT "t:~{shellDecodeUnix}"
 #Use SecRuleArgsCookies "~{UnixCmdDelim}passwd\s+(?:root|apache|nobody|-)"  2001211,tag:Command,tag:CmdDelim "t:~{shellDecodeUnix}"
 Use SecRuleArgsCookies "~{UnixCmdDelim}(?:apt-get|lwp-(?:download|request|mirror|rget)|smbclient)\s"  4003112,tag:BackendOS,tag:Command "t:~{shellDecodeUnix}"
 Use SecRuleArgsCookies "~{UnixCmdDelim}(?:gcc|uname)\s+-"  2001206,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeUnix}"
 Use SecRuleArgsCookies "~{UnixCmdDelim}(?:dnf|yum)\s.*(?:(?:local)?(?:install|up(?:d|gr)ate)|remove|erase|list|search|info|shell)\b"  2001208,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeUnix}"
 Use SecRuleArgsCookies "~{UnixCmdDelim}nmap\s"                           4003135,tag:BackendOS,tag:SHORT,tag:Command,tag:CmdDelim "t:~{shellDecode}"
 Use SecRuleArgsCookies "symlink"                                         4003115,tag:BackendOS,tag:Command,tag:CmdDelim,tag:PossibleName "t:~{shellDecode}"
 Use SecRuleArgsCookies "\bbusybox\b"                                     4003143,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecode}"
 Use SecRuleArgsCookies "~{UnixCmdDelim}openssl\ss_client"                4003108,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecode}"
 #Use SecRuleHeuristicArgsCookies "\bopenssl\b"  4003108,tag:BackendOS,tag:Command,tag:CmdDelim 2 "~{shellDecodeUnix}" "Possible Command Injection Attack (openssl s_client)"
 #Use SecRuleHeuristicArgsCookies "\bs_client\b" 4003108,tag:BackendOS,tag:Command,tag:CmdDelim 2 "~{shellDecodeUnix}" "Possible Command Injection Attack (openssl s_client)"
 #Use SecRuleHeuristicArgsCookies "-connect\b"   4003108,tag:BackendOS,tag:Command,tag:CmdDelim 2 "~{shellDecodeUnix}" "Possible Command Injection Attack (openssl s_client)"

 # Path using shell expansion * ? [...]
 Use SecRuleArgsCookies "/[a-z.]*[?*][a-z.?*]*/"                4003122,tag:BackendOS,tag:PATH,tag:Command,tag:Slash "t:~{shellDecodeUnix}"
 Use SecRuleArgsCookies "/(?:[a-z.?*]*[[][^]]*[]])+[a-z.?*]*/"  4003123,tag:BackendOS,tag:PATH,tag:Command,tag:Slash "t:~{shellDecodeUnix}"
 
 # Scripts
 Use SecRuleUrl  "/bin/([cks]|ba)?sh" 4003109,tag:BackendOS,tag:Slash "t:~{shellDecodeUnix},msg:'System path'"
 Use SecRuleUrl  "/tcl$"              4003110,tag:BackendOS,tag:Slash "t:~{shellDecodeUnix},msg:'System path'"
 Use SecRuleUrl  "/perl$"             4003111,tag:BackendOS,tag:Slash "t:~{shellDecodeUnix},msg:'System path'"

 # Shell expansion
 # Unix environment variables =>   ${ already blocked by '2000455'
 Use SecRuleArgsCookies "[$][{!]?[a-z_]"    4003113,~{linuxShellVarDecodeTag},tag:Dollar,tag:XQuery "multiMatch"
 Use SecRuleArgsCookies "[$][(]"            2001217,~{linuxShellVarDecodeTag},tag:Dollar            "multiMatch"
 Use SecRuleSubsetOf 2001217,tag:security,~{linuxShellVarDecodeTag},tag:Dollar 2001218
 Use SecRuleSubsetOf 4003137,tag:security,~{linuxShellVarDecodeTag},tag:Dollar 4003138
 Use SecRuleArgsCookies "[$][(][(]"         2001218,~{linuxShellVarDecodeTag},tag:Dollar "multiMatch"
 Use SecRuleArgsCookies "[$][\x27\x22]"     2001221,~{linuxShellVarDecodeTag},tag:Quote,tag:Dollar "multiMatch"
 Use SecRuleArgsCookies "[{]\s+[0-9-]+[.][.]\s+[0-9-]+(?:[.][.]\s+[0-9]*)?[}]"  2001222,~{linuxShellVarDecodeTag},tag:Dot,tag:CurlyBrace "multiMatch,t:~{linuxShellVarDecode}"
 Use SecRuleArgsCookies "[{].[.][.].(?:[.][.]\s+[0-9]*)?[}]"                    2001223,~{linuxShellVarDecodeTag},tag:Dot,tag:CurlyBrace "multiMatch,t:~{linuxShellVarDecode}"
 # $# = nb of arguments, $@ = all arguments, $? = exit status of the most recently run process
 Use SecRuleArgsCookies "[$][#@?]"          4003118,~{linuxShellVarDecodeTag},tag:Dollar "multiMatch"
 Use SecRuleSubsetOf 4003113,tag:security 4003119
 Use SecRuleArgsCookies "[$](?:LINENO|SECONDS|SELINUX|SHELL)" 4003119,~{linuxShellVarDecodeTag},tag:Dollar "t:none"

 # Output redirection
 Use SecRuleArgsCookies "<[(]" 2001219,~{linuxShellVarDecodeTag} "multiMatch"
 
 # Command separator manipulation
 Use SecRuleArgsCookies "\bIFS\s*+=" 4003114,tag:Equal,~{linuxShellVarDecodeTag} "t:~{shellDecodeUnix},msg:'Bash shell manipulation'"

 # BeanShell
 Use SecRulePathEverywhere "[.]bsh\b"      4003146,tag:BackendOS,tag:Command,tag:Dot,tag:SHORT "t:~{shellDecodeUnix}"

 # 'globstart' allows interpretation of '...'
 Use SecRulePathEverywhere "\bglobstar\b"  4003124,tag:BackendOS,tag:OSShell "t:~{shellDecodeUnix}"
 
 # Information leakage
 Use SecRuleResponse "Index of /"                         4003101,tag:BackendOS,tag:Command
 Use SecRuleResponse "uid=[(]"                            4003102,tag:BackendOS,tag:Command
 Use SecRuleResponse "/usr/local/"                        4003103,tag:BackendOS,tag:PATH
 Use SecRuleResponse "\broot:.{0,100}:0:(?:0|99999:7::):" 4003104,tag:BackendOS,tag:Command
 Use SecRuleResponse "/var/www"                           4003105,tag:BackendOS,tag:PATH
 Use SecRuleResponse "/process/"                          4003106,tag:BackendOS,tag:PATH
 Use SecRuleResponse "no such file or directory"          4003107,tag:BackendOS,tag:Command
</Macro>
