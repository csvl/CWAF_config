# Rules for web servers
# ---------------------------------------------------------------
# Range: 4003200-4003299

<Macro FrontendWebNginx>
 Use EmptyMacro
</Macro>
# Headers aimed at Nginx in front of the WAF
Use AllowResponseXHeader "Accel-(?:Buffering|Charset|Expires|Limit-Rate|Redirect)"


<Macro FrontendWebApache>
 # Remove unneeded information - how to do it only once?
 #Use Substitute  "s`<address>Apache/[^<]{0,200}</address>``i"

 # Security rules --------------------------------------------------------------
 # as Apache can be in front of another server, keep the previous rules
 Use SecRuleRemoveByFullTag FrontendWebApache

 Use SecRulePathEverywhere "\bht(?:access|passwd|group)\b"  4003215,tag:FrontendWebApache,tag:PATH         "~{caseSensitive}"
 Use SecRulePathEverywhere "\bwww_?acl\b"                   4003216,tag:FrontendWebApache,tag:PATH         "~{caseSensitive}"
 Use SecRulePathEverywhere "\bglobal[.]asa\b"               4003217,tag:FrontendWebApache,tag:PATH,tag:Dot "~{caseSensitive}"
 Use SecRulePathEverywhere "\bhttpd[.]conf\b"               4003218,tag:FrontendWebApache,tag:PATH,tag:Dot "~{caseSensitive}"
 Use SecRulePathEverywhere "/server-(?:info|status)"        4003219,tag:FrontendWebApache,tag:PATH         "~{caseSensitive}"
 Use SecRuleUrl  "/mod_pagespeed_"                          4003220,tag:FrontendWebApache         "~{caseSensitive},msg:'mod_pagespeed internal path'"

 # Block Apache directory content
 Use SecRuleDeny RESPONSE_HEADERS:Content-Type "unix-directory" "phase:3,id:4002225,t:none,~{statusResp}:404,tag:FrontendWebApache,msg:'Local directory enumeration is forbidden'"


 # Information leakage 
 Use SecRuleResponse "\bErrorDocument\b"                     4003201,tag:FrontendWebApache,tag:Develop

 Header unset "APACHE-TIME"
 Header unset "X-Mod-Pagespeed"
</Macro>

<Macro BackendWebApache>
 # Disable warning about web server
 Use SecRuleRemoveByID 1000104
 
 # This can be overwritten if needed
 Use BackendOSUnix

 Use FrontendWebApache
</Macro>

# Generic Java server
<Macro BackendWebJava>
 # Disable warning about web server
 Use SecRuleRemoveByID 1000104

 # This can be overwritten if needed
 Use BackendOSUnix
 Use FrameworkJava

 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByFullTag BackendWeb

 Use SecRuleUrl  "/manager/(?:html|text)"       4003206,tag:BackendWeb "~{increaseBlockCounterMax}"
 Use SecRuleUrl  "/test/jsp/"                   4003207,tag:BackendWeb "~{increaseBlockCounterMax}"
 Use SecRuleUrl  "/jsp/snp/"                    4003208,tag:BackendWeb "~{increaseBlockCounterMax}"
 Use SecRuleUrl  "/host-manager/"               4003209,tag:BackendWeb "~{increaseBlockCounterMax}"
 Use SecRuleUrl  "/implicit-objects.jsp"        4003210,tag:BackendWeb "~{increaseBlockCounterMax}"
 Use SecRuleUrl  "/sample/web/"                 4003211,tag:BackendWeb "~{increaseBlockCounterMax}"
 Use SecRuleUrl  "/examples/(?:jsp|servlet)"    4003212,tag:BackendWeb "~{increaseBlockCounterMax}"
 Use SecRuleUrl  "log4jAdmin"                   4003213,tag:BackendWeb "~{increaseBlockCounterMax}"
 Use SecRuleUrl  "/(?:meta|web)-inf"            4003225,tag:BackendWeb "~{increaseBlockCounterMax},msg:'Web server config path'"
 Use SecRuleUrl  "(?:jsp-reverse|cmdjsp)[.]jsp" 4003226,tag:BackendWeb "~{increaseBlockCounterMax},msg:'Backdoor path'"
  
 # view source attempt
 Use SecRuleUrl  "%[.]jsp"   4003214,tag:BackendWeb "~{increaseBlockCounterMax}"
 
 # Information leakage 
 Use SecRuleResponse "Directory Listing For /"    4003205,tag:BackendWeb,tag:Command
</Macro>

<Macro BackendWebTomcat>
 Use BackendWebJava
 Use SecRuleUrl  "/(?:jkstatus|host-manager[.]html)"     4003229,tag:BackendWeb "msg:'Tomcat admin path',~{increaseBlockCounterMax}"
 # servlet mapping cross site scripting attempt
 Use SecRuleUrl "/org[.]apache[.]catalina" 4003227,tag:BackendWeb,tag:Dot,tag:Slash "t:~{winPathDecode}"
 # XByteBuffer START_DATA header (CVE-2022-29885 and others)
 Use SecRuleArgsCookies "^flt2002" 4003231,tag:BackendWeb ""
</Macro>

# JBoss/Wildfly
<Macro BackendWebWildfly>
 Use BackendWebJava
 
 # Security rules --------------------------------------------------------------
 Use SecRulePathEverywhere "createscriptdeployment|loadconfig"  4003221,tag:BackendWeb,tag:PATH "t:~{shellDecode},msg:'JBoss/Wildfly config path'"
 Use SecRuleUrl  "/(?:admin|jmx)-console$"                      4003222,tag:BackendWeb "msg:'JBoss/Wildfly admin path',~{increaseBlockCounterMax}"
 Use SecRuleUrl  "/jmxinvokerservlet"                           4003223,tag:BackendWeb "msg:'JBoss/Wildfly admin path',~{increaseBlockCounterMax}"
 Use SecRuleUrl  "/web-console"                                 4003224,tag:BackendWeb "msg:'JBoss/Wildfly admin path',~{increaseBlockCounterMax}"

 # Information leakage 
 Use SecRuleResponse "JBoss Web/[0-9]"   4003204,tag:BackendWeb,tag:Develop
</Macro>

<Macro BackendWebLogic>
 Use BackendWebJava
 
 # Security rules --------------------------------------------------------------
 Use SecRuleUrl  "/wls-wsat"                4003208,tag:BackendWeb  "msg:'WebLogic admin path',~{increaseBlockCounterMax}"
 Use SecRuleUrl  "/_async"                  4003230,tag:BackendWeb,tag:noreport2  "msg:'WebLogic asynchronous operations path (CVE-2019-2725)',~{increaseBlockCounterMax}"
 Use SecRulePathEverywhere "weblogic[.]jms" 4003228,tag:BackendWeb  "msg:'BackendWebLogic namespace'"
 
 # Information leakage 
 Use SecRuleResponse "for server process administration"                         4003202,tag:BackendWeb
 Use SecRuleResponse "/idcplg/|/cs-admin/|IdcService=|GET_ROOT_IDC_ADMIN_PAGE"   4003203,tag:BackendWeb
</Macro>

<Macro BackendWebSphere>
 Use BackendWebJava
</Macro>

<Macro BackendWebGlassfish>
 Use BackendWebJava
</Macro>

<Macro FrontendWebOpenResty>
 Use FrontendWebNginx
 Use FrontFrameworkLUA
</Macro>
<Macro BackendWebOpenResty>
 Use FrontendWebOpenResty
 Use FrameworkLUA
</Macro>

<Macro BackendWebOther>
 # Disable warning about web server
 Use SecRuleRemoveByID 1000104

 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByFullTag BackendWeb
</Macro>
