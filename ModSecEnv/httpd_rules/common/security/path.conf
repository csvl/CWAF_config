# ModSecurity rules for Path traversal, etc.
# ---------------------------------------------------------------
# Range: 2000100-2000199

# Back slash is forbidden in URL (AllowEncodedSlashes Off) => in case of
Use SecRuleUrl  "\x5c"        2000101 "msg:'Backslash in path'"
# Current dir & Unix hidden hidden/system files (but allow /.NET framework/)
Use SecRuleUrl  "(?i)/[.](?!net)" 2000103 "msg:'/. in path'"
Use SkipAfterOnSuccess        2000101,tag:PATH,tag:security AfterDotDot
 # ..
 Use SecRuleUrl  "/[.][.]"     2000102 "msg:'.. in path'"
Use SecMarker AfterDotDot,tag:PATH,tag:security
# Trailing dot (before a /)
Use SecRuleUrl  "[.]/"        2000104 "msg:'./ in path'"

# Trailing dot (end of URI) -> covered by white-listing
Use SkipAfterOnSuccess 2002400,tag:security,tag:PATH AfterPathEndDot
 Use SecRuleBasename  "[.]$"  2000105 "msg:'Path ending with dot'"
Use SecMarker AfterPathEndDot,tag:security,tag:PATH

# Two extensions (two dots)
#Use SecRuleBasename "[.][^/]*[.]"  2000107 "t:none,msg:'2 dots in URL (double extension), allow with [Use SecAllowMultipleExtInUrl]'"

# MacOS extended attributes
Use SecRuleBasename "__macos"  2000100 "msg:'Internal file'"

Use SecRuleArgsCookies "\bbackup_?data\b"  2000114,tag:PossibleName,tag:PATH,tag:Parano  "msg:'Backup path',~{caseSensitive}"

Use SecRuleUrl "(?i)(?:^|/)default[.]xml"           2000194  ""

# Dot in the directory part of the URL (allow version numbers - ex: /jquery-ui/1.10.2/, /keycloak.v2)
Use SecRuleUrl "[^.]*+(?:[./]v?+[0-9.]*+/[^.]*+)*+.*[.][^/]+/"  2000112,tag:Dot,tag:Slash "t:none,~{caseSensitive},msg:'Dot in the directory part of the URL, allow with [Use SecAllowDotInUrl]'"

# ./ /. etc.
# Allowed: .../ /... S.A./N.V.
Use SecRuleArgs    "(?<![.][.])[.][/\x5c](?!(?i)(?:N[.]V[.]|S[.]A[.]))" 2000113,tag:Dot,tag:PATH "multiMatch,msg:'./ in ARG',t:~{shellDecode}"
Use SkipAfterOnSuccess                2000113,tag:Dot,tag:PATH,tag:security AfterArgDotDotSlash
 Use SecRuleArgs   "(?<![.])[.][.][/\x5c]"  2000111,tag:Dot,tag:PATH "multiMatch,msg:'../ in ARG',t:~{shellDecode}"
Use SecMarker             AfterArgDotDotSlash,tag:Dot,tag:PATH,tag:security
Use SecRuleHeaders "[.][/\x5c]"             2000115,tag:Dot,tag:PATH "multiMatch,msg:'./ in header',t:~{shellDecode}"
Use SkipAfterOnSuccess                2000115,tag:Dot,tag:PATH,tag:security AfterArgDotDotSlash
 Use SecRuleHeaders "[.][.][/\x5c]"         2000127,tag:Dot,tag:PATH "multiMatch,msg:'../ in header',t:~{shellDecode}"
Use SecMarker             AfterArgDotDotSlash,tag:Dot,tag:PATH,tag:security
Use SecRuleCookies  "[.][/\x5c]"            2000128,tag:Dot,tag:PATH "t:~{shellDecode},msg:'./ in cookies'"
Use SkipAfterOnSuccess                2000128,tag:Dot,tag:PATH,tag:security AfterArgDotDotSlash
Use SecRuleCookies "[.][.][/\x5c]"          2000106,tag:Dot,tag:PATH "t:~{shellDecode},msg:'../ in cookies'"
Use SecMarker             AfterArgDotDotSlash,tag:Dot,tag:PATH,tag:security
# /.
Use SecRuleArgs    "[/\x5c][.](?![.][.])"   2000124,tag:Dot,tag:PATH "multiMatch,msg:'/. in input',t:~{shellDecode}"
Use SecRuleHeaders "[/\x5c][.]"             2000125,tag:Dot,tag:PATH "multiMatch,msg:'/. in header',t:~{shellDecode}"
Use SecRuleCookies "[/\x5c][.]"             2000126,tag:Dot,tag:PATH "t:~{shellDecode},msg:'/. in cookies'"

Use CheckUriInArgs_    2000109 2000108
Use CheckUriInCookies_ 2000110 2000117
Use CheckUriInHeaders_ 2000118 2000119
# Only when content is XML
<IfDefine !noXML>
 Use CheckUriInXMLBody_ 2000120 2000121
 Use SecRuleSubsetOf 2000120,tag:security,tag:URL,tag:Slash 2000122,tag:security,tag:URL,tag:Slash
 Use SecRuleSubsetOf 2000121,tag:security,tag:URL,tag:Slash 2000123,tag:security,tag:URL,tag:Slash
 Use CheckUriInXMLEntities_ 2000122 2000123
</IfDefine>

# Skip if both 2000109 & 2000110 where executed
Use SkipAfterOnSuccess2 2000109 2000110 ",tag:colon,tag:Slash,tag:PATH,tag:security" AfterProtocolInclusion
 # Remote Protocol Inclusion: ...://
 Use SecRuleArgsCookies "\b(?i:data|dns|expect|glob|iiop|ldaps?|ogg|resource|php|rar|resource|rmi|s?ftps?|ssh2?|tcp|zip|zlib)://" 2000116,tag:specific,tag:Parano,tag:Colon,tag:Slash "msg:'Remote File Inclusion (URL)',logdata:'%{MATCHED_VAR_NAME} contains <%{TX.1}>'"
 # Local Protocol Inclusion: file://, smb://, mediagrid:// (video shared storage)
 Use SecRuleArgsCookies "\b(?i:file|mediagrid|smb)://" 2000130,tag:URLINC,tag:Colon,tag:Slash "msg:'Local file protocol',logdata:'%{MATCHED_VAR_NAME} contains <%{TX.1}>'"
Use SecMarker AfterProtocolInclusion,tag:colon,tag:Slash,tag:PATH,tag:security

# Backups, etc.
Use SecRuleUrl  "(?i)/backup"        2000197,tag:Parano  "msg:'System path'"
Use SecRuleUrl  "(?i)/install"       2000198,tag:Parano  "msg:'System path'"
Use SecRuleUrl  "(?i)/changelog"     2000199,tag:Parano  "msg:'System path'"

# Various admin paths
Use SecRuleUrl  "(?i)^/config/"       2000181  "msg:'Admin path'"
Use SecRuleUrl  "(?i)^/soap/.*/spy"   2000182,tag:Parano  "msg:'Admin path'"
Use SecRuleUrl  "(?i)^/xsl/demo"      2000183  "msg:'Admin path'"
Use SecRuleUrl  "(?i)/admin(?:/|$)"   2000184  "msg:'Admin path'"
Use SecRuleUrl  "(?i)^/passwords"     2000185,tag:Parano  "msg:'Admin path'"
Use SecRuleUrl  "(?i)^/debug"         2000131  "msg:'Admin path'"

# swagger/openapi files
Use SecRuleUrl  "/_*swagger_*(?:-(?:resources|ui))?[/.]"    2000105,tag:Parano "~{caseSensitive},msg:'swagger files not public'"
Use SecRuleUrl  "/api[-_]*docs?"                            2000129,tag:Parano "~{caseSensitive},msg:'openapi files not public'"

# Allow multiple dots for CSS & JS files
<LocationMatch [.](?:css|js)$>
 Use SecAllowMultipleExtInUrl
</LocationMatch>

# Allow spaces in font names
<LocationMatch [.](?i)~{FontFileExt}$>
 Use SecAllowCharsInBasename " "
</LocationMatch>
