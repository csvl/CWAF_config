<Macro Bitbucket_Proxy_ $(ssl) @frontServer $frontPath @protocol $backServer $backPort @backPath>
 Use Proxy$(ssl)Ext @frontServer "$frontPath" @protocol "$backServer" $backPort @backPath
 Use SecWebAppId Bitbucket
 
 Use UTF8Encoding "^$frontPath/"
 
 Use SecDisableRuleExt "@contains bitbucket" "^$frontPath/j_atl_security_check" ARGS:queryString 2000397
 
 Use ParseArgInURL "^($frontPath/(?:rest/api/latest/)?projects)/([^/]+/repos/.*)"
 #Include .git in param or AllowDotInURL
 Use ParseArgInURL "^($frontPath/scm)(/[^/]+/[^/]+[.]git)(.*)"
 
 Use Atlassian "$frontPath"
  
 <Location $frontPath/>
  Use PackageSoftware
  Use AcceptCookie BITBUCKETSESSIONID
  # Remember me in a cookie, but userid not inside
  Use AcceptCookie _atl_bitbucket_remember_me
 
  Use CSPAllowInternalScript
  Use CSPAllowInternalStyle
  Use CSPAddDirective img-src "data:"
  
  Use SecAllowBase64
  Use SecAllowQueryInPost
  Use SecAllowTechnicalArgs
  Use SecAllowExt "md|git"
  Use SecUrlAllowChars "~:"
  Use AllowJSON
  Use SecAllowDotInUrl
  Use SecAllowCharsInBasename ","
  Use SecAllowAllExt
  Use AllowAutomatedTools
 </Location>
 
 <Location $frontPath/admin>
 # Allow /admin
  Use SecRuleremoveById 2000184
 </Location>
 
 <LocationMatch ^$frontPath/(undefined/)?rest/>
  Use SecArgNameAllowEmpty
  Use SecAllowJsonInArgs
  Use AllowJavaHttpClient
 </LocationMatch>
 
 <LocationMatch ^$frontPath/(download|s)/>
  Use SecUrlAllowChars ":,"
  Use SecAllowCharsInUpDownDocs "@"
 </LocationMatch>
 
 <Location $frontPath/plugins/servlet/ssh/account/keys>
  Use SecAllowPemInArgs
 </Location>
 
 <Location $frontPath/scm>
  Use SecAllowContentType "application/x-git-upload-pack-request"
  Use SecAllowContentType "application/x-git-receive-pack-request"
  Use AllowCompressedRequest
 </Location>
</Macro>

<Macro Bitbucket_Proxy @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use Bitbucket_Proxy_ "" @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro Bitbucket_ProxySSL @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use Bitbucket_Proxy_ SSL @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>
