# Macros and rules defined for TFS
# ----------------------------------
# Range: 2004000-2004009

<Macro EnableTfsPath>
 #Use SecRule TX:url  "(?i)^(?:$path)"  "phase:1,t:none,tag:security,~{nosecaction},ctl:ruleRemoveById=2004001"
 Use SecRuleRemoveByID 2004001
</Macro>
<Macro EnableTfsCollection>
 Use EnableTfsPath
</Macro>

<Macro DisableTfsAdministration>
 Use SecRule TX:url  "[.]js$"  "phase:2,t:none,tag:security,~{skipAfter}:AfterTFSAdminCheck"
  Use SecRuleUrl  "(?i)/(?:_admin|TFS[.]Admin|Reports|VersionControl)"  2004002,tag:AccessControl  "t:none,msg:'TFS admin pages not allowed'"
 Use SecMarker AfterTFSAdminCheck,tag:security
 Use SecRule ARGS:property "!(?i)^Action$"  "phase:2,t:none,tag:specific,tag:security,~{skipAfter}:AfterPropertyAction"
  Use SecRuleDeny ARGS:value "(?i)^Manage$" "phase:2,t:none,tag:specific,msg:'TFS admin params not allowed'"
 Use SecMarker AfterPropertyAction,tag:security
</Macro>
<Macro EnableTfsAdministration>
 Use SecRuleRemoveByID 2004002
</Macro>

<Macro DisableTfsDev>
 Use SecRuleUrl  "(?i)/(?:_build|_versionControl)"  2004003,tag:AccessControl  "t:none,msg:'TFS development pages not allowed'"
</Macro>
<Macro EnableTfsDev>
 Use SecRuleRemoveByID 2004003
</Macro>

<Macro TFSRules_ $frontPath>
 Use ProxyPreserveHost off
 Use UTF8Encoding "^$frontPath/"
 Use FrameworkSharepoint
 
 Use secAction "phase:1,~{nosecaction},setvar:'tx.allowedUrlProtos=vstfs:/'"

 <Location $frontPath/>
  Use PackageSoftware
  Use RemapURL
  Use SecAllowExt "asmx|aspx|axd|[0-9]+"
  Use SecArgNameAllowCharacter "$"
  Use CSPAllowEvalInScript
  Use AcceptCookie TSWA-Session-Vars
  Use SecNoCheckResponse
  Use SecRestrictUsername "/UserName$/"
  Use SecAllowURL
  Use SecAllowTechnicalArgs
  # Superseded by SecAllowTechnicalArgs: Use SecArgsAllowUnicode
  Use SecUrlAllowAllChars
  Use SecAllowUpFileExt  "~{TechnicalUpFileExt}"
  Use SecAllowQueryInPost
  Use CSPallowInternalScript
  Use CSPallowInternalStyle
  Use SecAllowMultipleExtInUrl
  Use SecAllowDotInUrl
  Use SecAllowUpChars " ()"
  Use SecAllowAllDownFileExt
  Use SecArgNameAllowEmpty

  # Invalid multipart/form-data requests: last separator contains a newline before final --
  Use IgnoreReqBodyParsingError

  # For Visual Studio
  Use AllowWebDAV
  # Visual Studio does not always send a User-Agent
  Use AllowEmptyUA

  Use DisableTfsAdministration
  Use DisableTfsDev
  Use SecRuleUrl  @unconditionalMatch  2004001,tag:AccessControl  "t:none,msg:'URL not allowed'"

  Header unset "X-TFS-ProcessId"
 </Location>

 <LocationMatch "^$frontPath/(?i)_(?:plugins|static)/">
  Use EnableTfsPath
 </LocationMatch>

 <LocationMatch ^$frontPath/.*[.]asmx$>
  Use SecAllowSOAP 250000
 </LocationMatch>

 <LocationMatch ^$frontPath/(?![^/]+/(?i:VersionControl/.*/repository[.]asmx))>
  Use RemapURLinXML
 </LocationMatch>

 # Special upload features
 <LocationMatch ^(?i:$frontPath/[^/]+/(?:(VersionControl|Services)/.*/[^/]*upload|WorkItemTracking/v1.0/AttachFileHandler)[.]ashx)$>
  # TFS uses several parameters (name without extension)
  Use SecAllowUpNoFileExt
  Use SecAllowAllUpFilenames
  # Store filename from parameter
  Use SecRule ARGS:item "([^/]{1,200})$" "phase:2,t:none,t:normalisePathWin,t:lowercase,~{nosecaction},capture,setvar:TX.uploadfname=%{TX.1},msg:'fname=%{TX.uploadfname}'"
 </LocationMatch>
</Macro>

# Macros and rules for TFS2008 =========================================

<Macro TFS2008_Proxy_ $(ssl) @frontServer $frontPath @protocol $backServer $backPort @backPath>
 Use Proxy$(ssl)Ext @frontServer "$frontPath" @protocol "$backServer" $backPort @backPath
 Use SecWebAppId TFS2008
 Use TFSRules_ "$frontPath"

 Use SecBadAuthPage "$frontPath/UI/Pages/Login.aspx"

 <Location "$frontPath/UI/Pages/Login.aspx">
  Use Substitute "s`value=(.)?(https?://)`value=$1--NOURLSUBST--$2`i"
 </Location>

 <LocationMatch "^$frontPath/UI/Pages/WorkItems/.*bmp$">
  Use SecIgnorePageNotFound
 </LocationMatch>

 <Location $frontPath/Resources/Images/null.gif>
  Use SecRuleEngine off
 </Location>

 <Location $frontPath/UI/Pages/WorkItems/WorkItemEdit.aspx>
  Use SecRuleRemoveByID 2000111
 </Location>
</Macro>

<Macro TFS2008_Proxy @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use TFS2008_Proxy_ "" @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro TFS2008_ProxySSL @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use TFS2008_Proxy_ SSL @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>


# Macros and rules for TFS2010 =========================================

<Macro TFS2010_Proxy_ $(ssl) @frontServer $frontPath @protocol $backServer $backPort @backPath>
 Use Proxy$(ssl)Ext @frontServer "$frontPath" @protocol "$backServer" $backPort @backPath
 Use SecWebAppId TFS2010
 Use TFSRules_ "$frontPath"
</Macro>

<Macro TFS2010_Proxy @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use TFS2010_Proxy_ "" @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro TFS2010_ProxySSL @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use TFS2010_Proxy_ SSL @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>


# Macros and rules defined for TFS2013 =========================================

<Macro TFS2013_Proxy_ $(ssl) $frontServer $frontPath @protocol $backServer $backPort @backPath>
 Use ChangeBasicAuthBanner "$frontServer"
 Use Proxy$(ssl)Ext $frontServer "$frontPath" @protocol "$backServer" $backPort @backPath
 Use SecWebAppId TFS2013
 Use TFSRules_ "$frontPath"
</Macro>
 
<Macro TFS2013_Proxy @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use TFS2013_Proxy_ "" @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro TFS2013_ProxySSL @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use TFS2013_Proxy_ SSL @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro TFS2013_BeginSSLVhost @frontServer @sourceIp @frontPath @protocol @backServer @backPort @backPath>
 Use BeginSSLVhost @frontServer @sourceIp
  Use TFS2013_ProxySSL  @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>
