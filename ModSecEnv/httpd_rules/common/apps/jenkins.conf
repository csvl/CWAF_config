# Rules for Jenkins
# ---------------------------------------------------------------
# Range: 6000000-6000019
<Macro Jenkins_Proxy_ $(ssl) @frontServer $frontPath @protocol $backServer $backPort @backPath>
 Use Proxy$(ssl)Ext @frontServer "$frontPath" @protocol "$backServer" $backPort @backPath
 Use SecWebAppId Jenkins
 Use UTF8Encoding "^$frontPath/"
 
 Use ParseArgInURL "^($frontPath/job/)(.+)$

 <Location $frontPath/>
  Use PackageSoftware
  Use BackendWebJava
  Use DBNone
  Use FrameworkStapler
  Use Groovy
  
  # Specific security rules
  Use SecRuleArgsCookies "org[.]jenkins" 6000001,tag:specific,tag:Dot "msg:'Jenkins namespace'"

  Use AcceptCookie "jenkins-timestamper-offset"
  Use AcceptCookie "screenResolution"
  Use AcceptCookie "hudson_auto_refresh"
  
 ## To confirm. A lot of 403 "from backend" found in logs.
  ##Header unset "X-Jenkins"
  # Header unset "X-Jenkins-Session"
  ##Header unset "X-Hudson"
  # Header unset "X-Hudson-Theme"
  # Header unset "X-Instance-Identity"
  ##Header unset "X-You-Are-In-Group-Disabled"
  ##Header unset "X-You-Are-Authenticated-As"
  ##Header unset "X-Required-Permission"
  ##Header unset "X-Permission-Implied-By"
  # Header unset "X-Plugin-From"
  # Header unset "X-Plugin-Long-Name"
  # Header unset "X-PluginShort-Name"
  
  Use NoResponseHeaderWarning
 
  Use SecArgSizeMax 15000
  Use SecArgsNbMax    800
  Use CSPallowInternalScript
  Use CSPallowInternalStyle
  Use CSPAllowEvalInScript
  Use CSPAllow3rdPartyScript "usage.jenkins.io"
  
  Use SecUrlAllowChars " $~{UnicodeLetters}"
  Use SecAllowDotInUrl
  
  Use SecAllowQueryInPost
  
  Use SecArgsAllowUnicode
  # Use SecAllowTechnicalArgs
  Use SecArgNameAllowCharacter "%\x5b\x5d$:"
  Use SecAllowJsonInArgs
  # Allow $ followed by letters (and specifically $class)
  Use SecRuleRemoveById 4003113,4003721
  Use SecAllowPemInArgs

 #Count login page as authentication error
  Use SecAcegiAuth "(?i:/loginError)"
 
  Use DoNotTrapError 404
  # Allow "\^|
  Use SecArgsAllowAllChars
 </Location>
 
 <LocationMatch ^$frontPath/static/[a-z0-9]+/descriptor/org.jenkinsci.plugins.workflow.job.console.NewNodeConsoleNote/>
  # Allow org.jenkinsci in the path
  Use SecRuleRemoveById 6000001
 </LocationMatch>
 
 <Location $frontPath/credentials/store/system/domain/_/createCredentials>
  # Allow org.jenkinsci in ARGS
  Use SecRuleRemoveById 6000001
 </Location>
 
 <Location $frontPath/administrativeMonitor>
  # Allow /admin in the path
  Use SecRuleRemoveById 2000184
  Use AllowJSON
 </Location>
 
 <Location $frontPath/computer>
  Use SecAllowTechnicalArgs
 </Location>

 <Location $frontPath/computer/(master)>
  Use SecUrlAllowChars "("
 </Location>
 
 <Location $frontPath/configSubmit>
  Use SecAllowTechnicalArgs
  Use SecAllowBackSlash
  Use SecArgNameAllowCharacter ":$"
 </Location>

# Allow $alphab in args
 <Location $frontPath/credentials/store/system>
  # allow path /system/
  Use SecRuleRemoveById 2001209
  # allow Windows path is ARGS
  Use SecAllowWindowsPath
 </Location>
 
 # $PatternProjectNamingStrategy is not a macro parameter and will not be replaced
 <Location $frontPath/descriptorByName/jenkins.model.ProjectNamingStrategy$PatternProjectNamingStrategy/checkNamePattern>
  Use SecAllowRegex
 </Location>
 
 <LocationMatch ^$frontPath/(DescriptorByName/|configureSecurity/configure$)>
  # ${...}
  Use SecRuleRemoveById 4003113
  # %{...}
  Use SecRuleRemoveById 2000458
#  Use SecArgNameAllowCharacter ":"
  #Allow Regex in arg "value" -caret-
  Use SecRuleRemoveById 2000222
 </LocationMatch>
 
 <Location $frontPath/j_acegi_security_check>
  Use SecAcegiAuth  “loginError”
  Use SecRestrictUsername "j_username"
  Use SecPassword "j_password"
 </Location>
 
 <Location $frontPath/job>
  Use SecRuleRemoveById "4003724"
  Use DoNotTrapError 500
#  Use SecUrlAllowChars "'"
  Use SecAllowTechnicalArgs
  Use SecAllowExt "gradle"
 </Location>
 
 <Location $frontPath/opensearch.xml>
  Use SecAllowAllExt
 </Location>

 <Location $frontPath/pluginManager>
  Use SecArgSizeMax 200000
  Use SecAllowBackSlash
 </Location>

 <Location $frontPath/sonarqube-webhook>
  # Allow "localhost" for sonarqube access
  Use SecRuleRemoveById 2000234
  Use SecAllowURL
  Use AllowJSON
 </Location>
 
 <Location $frontPath/script>
   # Allow parenthesis and curly brace in /script for args script and json
  Use SecRuleRemoveById 2000351   
 </Location>
 
 <Location $frontPath/user>
  Use SecUrlAllowChars "@"
  Use SecAllowExt "be"
 </Location>
</Macro>

<Macro Jenkins_Proxy @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use Jenkins_Proxy_ "" @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>
<Macro Jenkins_ProxySSL @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use Jenkins_Proxy_ SSL @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>
