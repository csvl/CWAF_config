# Common settings to all Atlassian products

# These paths are needed for discovery, before authentication
# login info:
#    /rest/nativemobile/[0-9.]+/info/login
#    /server-info.action for Confluence < 7.6 & /server-info for Jira < 8.9.1
# Open Search Description: osd.jsp
DefineStr AtlassianUnauthPaths "/(?:rest/nativemobile/[0-9.]+/info/login|server-info(?:[.]action)?|(?:.*/)?osd[.](?:action|jsp))$"

<Macro Atlassian $frontPath>
 # For SAML plugin
 DefineStr AtlassianSamlPluginTokens "(?:ESTSAUTH|session-data-|SignInStateCookie)[a-z0-9-]*"
 ###########DefineStr AtlassianSamlPluginTokens "session-data-[a-z0-9-]*"
 Use SecRuleIgnoreTargetsRegexByTagUrl "^$frontPath/" Base64 "REQUEST_COOKIES:'/^(?:~{AtlassianSamlPluginTokens})$/'" 

 # Don't redirect when not authenticated in mod_oidc for AgileCraft server
 Use SecRule REQUEST_HEADERS:User-Agent "AgileCraft[.]Jira[.]Api" "~{Oidc401Action_},setenv:moidc401=AgileCraft"

 # Bug in (at least) Jira: https://jira.atlassian.com/browse/CONFCLOUD-60235
 Use SecRule TX:BASENAME "^[$][{]?(?i:iconUrl|statusIcon)" "phase:1,tag:URL,~{stop404}"

 <Location $frontPath/>
  Use PackageSoftware
  Use BackendWebTomcat
  Use FrameworkSpring
  Use FrameworkJSP
  Use DBPostGres
  Use ORM
  Use DoNotTrapError 400

  Use OAuth1
  
  Header unset X-ASEN
  Use RegisterUsername X-AUSERID
  Use RegisterUsername X-AUSERNAME
  Use AllowResponseXHeader "Atlassian-(?:Dialog-Control|WebSudo)|AUSER(?:ID|NAME)|A(?:REQUEST|SESSION)ID|Seraph-LoginReason"
  Use AcceptCookieRegex "atlassian[.][a-z._]+"
  Use AcceptCookieRegex "crowd[.][a-z._-]+"
  Use AcceptCookieRegex "seraph[.][a-z.-]+"
  # For SAML plugin
  Use AcceptCookieRegex "fpc|~{AtlassianSamlPluginTokens}"

  # For mobile apps
  Use CookieNotHttpOnly atlassian[.]xsrf[.]token
  #Use SecIgnoreCookie "seraph.rememberme.cookie"
  
  Use SecArgsAllowUnicode
  Use SecNoCORSWarning
  
  # Atlassian products use a lot of headers
  Use NoResponseHeaderWarning
  
  # auto-update features 
  Use CSPAllowJSConnect  "https://update-nucleus.atlassian.com https://marketplace.atlassian.com"
  
  # Several paths buggy and httpd removes the multiple / anyway
  Use AllowDoubleSlashInURL

  # When loading a CSS from Jira, and it loads a resource from Confluence, Referer <> Origin
  Use SecRuleRemoveById 2002954

  # Allow /admin in the path
  Use SecRuleRemoveById 2000184

  # Allow all chars in Referer
  Use SecRefererUrlAllowAllChars

  # Technical products => disable some rules
  Use SecRuleRemoveByFullTag SHORT
  
  Use NoOidcHeaders
  
  Use SecBadAuthArg "permissionViolation" "^true"
  
  #Use SecRuleHeader X-Atlassian-Token "^no-check" "tag:exploit,msg:'CVE-2023-22515'"
  
  Use SecAllowContentType "text/x-log"
  Use NoJSONAutodetect    "text/x-log"
 </Location>
 
 # These paths are needed for discovery, before authentication (dynamic pages)
 <LocationMatch ^$frontPath~{AtlassianUnauthPaths}>
  Use PublicResource
 </LocationMatch>

 # Image included in e-mails
 <LocationMatch ^$frontPath(?:/images/(?:icons|mail)/[-a-z/]+|/trackback)[.]~{ImagesFileExt}$>
  Use PublicImages
 </LocationMatch>

 # Usual locations with incorrect links
 <LocationMatch ^$frontPath/(?:rest|s)/>
  Use SecIgnorePageNotFound
 </LocationMatch>

 # Atlassian products use image filename containing "@"
 <LocationMatch ^$frontPath/.*/[a-zA-Z0-9@]+[.]~{ImagesFileExt}$>
  Use SecAllowCharsInUpDownDocs "@"
 </LocationMatch>

 #aha! is a plugin for Atlassian softs
 <LocationMatch /aha![.]png$>
  Use SecAllowCharsInBaseName "!"
 </LocationMatch>

 # Mobile app => never 401?
 #Use SecRule REQUEST_HEADERS:User-Agent "AtlassianMobileApp" "~{Oidc302Action}"

 <Location $frontPath/server-info.action>
  Use SecRuleDeny ARGS:bootstrapStatusProvider.applicationConfig.setupComplete "^false" "msg:'Hacking attempt'" 
  #Use SecRuleDeny &ARGS:/^bootstrapStatusProvider/ "@gt 0" "msg:'Hacking attempt'" 
 </Location>
 
 # JSESSIONID poses problem on /plugins/servlet/samlconsumer URL and isn't normally sent when no WAF !?!
 # So delete on previous request
 #<Location $frontPath/plugins/servlet/external-login/3>
 # Header set Set-Cookie "JSESSIONID=;expires=Tue, 15 Nov 1994 08:12:31 GMT;Path=/;Secure;HttpOnly"
 #</Location>
 #<LocationMatch /download/resources/com.atlassian.plugins.authentication.atlassian-authentication-plugin:save-fragment/js.cookie.js>
 # Header set Set-Cookie "JSESSIONID=;expires=Tue, 15 Nov 1994 08:12:31 GMT;Path=/;Secure;HttpOnly"
 #</LocationMatch>
 # JSESSIONID poses problem on that URL and isn't normally sent when no WAF !?!
 #<Location $frontPath/plugins/servlet/samlconsumer>
 # Use SecRule ENV:allowedCookies "^(.*;?)JSESSIONID=[^;]*;?(.*)$" "phase:2,~{nosecaction},tag:security,capture,setenv:allowedCookies=%{TX.1}%{TX.2}"
 #</Location>

 <Location $frontPath/plugins/servlet/saml/auth>
  Use SecNoReferrerPolicy
  Use SecIgnoreCORS
 </Location>

 <LocationMatch ^$frontPath/(?:json/setup-restore|setup)>
  Use SecRestrictIp -
 </LocationMatch>
 
 <LocationMatch ^$frontPath/(?:download|s)/>
  Use SecUrlAllowChars ":@, ~"
  Use SecAllowDotInUrl
 </LocationMatch>
 
 #<LocationMatch ^$frontPath/rest/whitelist/[^/]+/check>
 # Use SecRestrictIp -
 #</LocationMatch>
 #<LocationMatch ^$frontPath/rest/api/[^/]+/render>
 # Use SecRestrictIp -
 #</LocationMatch>
 #<Location $frontPath/secure/admin>
 # Use SecRestrictIp -
 #</Location>
</Macro>

