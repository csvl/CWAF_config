# ModSecurity rules for Confluence
# ---------------------------------------------------------------
# Range: 6000020-6000039

#"Content-type: application/json" but not JSON body ---------------------------------------
DefineStr confl_badJson_rest1 "experimental/relation/user/current/favourite/toContent/"
DefineStr confl_badJson_rest2 "jiraanywhere/1.0/jira/clientIds"
# atlassian-token=54bcadd1bcd582cceb764e0888bd260679c515ce
DefineStr confl_badJson_rest3 "likes/[0-9.]+/content/[0-9]+/likes$"
#OAuth2 token: eyJhbGciOiJIUzI1NiJ9.eyJsYXp5Qm9keSI6IjxoMyBpZD1c...
DefineStr confl_badJson_rest4 "contentformatting/latest/macros/tabpage/exec"
# atl_token=1d00b057cb0cbfed52f1737b6f4be419601764de
DefineStr confl_badJson_rest5 "api/user/watch/"
DefineStr confl_badJson_rest "rest/(?:~{confl_badJson_rest1}|~{confl_badJson_rest2}|~{confl_badJson_rest3}|~{confl_badJson_rest4}|~{confl_badJson_rest5})"
DefineStr confl_badJson_sync "synchrony(?:-proxy)?/v1/data/Synchrony-[-0-9a-f]+/confluence-[0-9]+$"
DefineStr confl_badJson_plugins "plugins/drag-and-drop/upload.action$"
DefineStr confl_badJson      "(?:~{confl_badJson_rest}|~{confl_badJson_sync}|~{confl_badJson_plugins})"

<Macro Confluence_Proxy_ $(ssl) $frontServer $frontPath @protocol $backServer $backPort $backPath>
 Use ProxyWebSocket "s" "$frontPath/synchrony-proxy/v1/bayeux-sync1" "$backServer:$backPort$backPath/synchrony-proxy"
 Use Proxy$(ssl)Ext "$frontServer" "$frontPath" @protocol "$backServer" $backPort "$backPath"
 Use SecWebAppId Confluence
 
 Use UTF8Encoding "^$frontPath/"
 
 Use ParseArgInURL "^($frontPath/pages/)([^/]+)/([a-z0-9]+[.]action)$"
 Use ParseArgInURL "^($frontPath/display/)(.+)$"
 Use ParseArgInURL "^($frontPath/pages/[0-9]+/)([^/]+)$"
 Use ParseArgInURL "^($frontPath/download/(?:attachements|thumbnails)/[0-9]+/)([^/]+)$"
 
 Use SecRequestBodyProcessor "^DELETE" "^/rest/synchrony/1.0/content/" URLENCODED
 Use SecRequestBodyProcessor "^DELETE" "^/rest/api/content/"           URLENCODED
 
 Use Atlassian "$frontPath"
 
 # cql: Query language
 # os_destination: path after login => all characters that where allowed in ARGS for this path 
 Use SecRuleIgnoreTargetsByTagUrl "^$frontPath/" security ARGS:body.editor.value,ARGS:cql,ARGS:content,ARGS:os_destination
   
 <Location $frontPath/>
  Use SecWebAppId Jira
  Use DisableParanoidMode
  
  Use FrameworkVelocity

  Use AcceptCookieRegex "confluence[-.][a-z.-]+"
  Use AcceptCookie "mywork.tab.tasks"
  Use AcceptCookie "authenticated"
  # Find "|" as separator
  Use SecCookieByteRange "124"
  
  # no more needed for Confluence 7.6+
  Use AllowResponseXHeader "Confluence-Request-Time"
  #Header unset "Confluence-Request-Time"
  Header unset "X-Confluence-Cluster-Node-Name"
  
  Use CSPAllowInternalStyle
  Use CSPAllowInternalScript
  Use CSPAllowImages "data:"
  Use YouTube
  
  Use SecAllowExt "action|site[.]logo"
  Use AllowJSON
  Use SecAllowJsonInArgs
  Use SecAllowQueryInPost
  Use SecAllowCalculation
  Use SecURLAllowAllChars
  Use SecAllowPipeInArgs
  
  Use SecIgnoreCORS
  
  Use SecArgsNbMax 400
  Use SecUploadFileLimit 10
  
  Use HeaderLimitedChars__ 6000021 REQUEST_HEADERS:X-Apppath none ",26,92,94,124"
 </Location>
 
 <Location $frontPath/spaces/doeditspacepermissions.action>
  Use SecArgNameAllowCharacter "#"
 </Location>
 
 <Location $frontPath/admin>
  # Allow /admin
  Use SecRuleRemoveById 2000184
  # Allow URI in headers: why?
  Use SecRuleRemoveById 2000118
  Use SecAllowTechnicalArgs
 </Location>

 <LocationMatch $frontPath/(?:admin|setup)(?:/|$)>
  Use SecRestrictIpInternal
 </LocationMatch>

 <Location $frontPath/display>
  Use SecAllowCharsInUpDownDocs " "
  Use SecAllowPlusInUpDownDocs
  Use SecAllowTechnicalArgs
 </Location>
 
 <Location $frontPath/download>
  #username as filename /path/xx/forname.name
  Use SecAllowAllExt
  Use SecAllowMultipleExtInUrl
  Use SecAllowCharsInUpDownDocs "'~"
  Use SecAllowPlusInUpDownDocs
  Use SecAllowUpDownFileExt "html"
 </Location>
  
 <LocationMatch ^$frontPath/(?:display|rest)/>
  #username as filename /path/xx/forname.name
  Use SecAllowAllExt
  Use SecAllowMultipleExtInUrl
 </LocationMatch>
 
 <LocationMatch ^$frontPath/(?:do)?login[.]action>
  #Allow .action=, src= in arg
  Use SecRuleRemoveById 2000305,2000361,2000397,2000878
 </LocationMatch>
 
 <Location $frontPath/plugins>
  # Allow URL as /plugins/servlet/upm/license/com.lucidchart.onprem.confluence.plugins.lucid-onprem-confluence or .../fallback/Latin1Supplement.br
  Use SecAllowAllExt
  Use SecAllowUpFileExt "json"
  Use SecAllowCharsInBasename "$"
 </Location>
 
 # JSON sent with "Content-Type: application/octet-stream"
 <Location $frontPath/plugins/drag-and-drop/upload.action>
  Use SecAllowContentType "application/octet-stream"
  Use NoReqContentAutodetect
 </Location>
 
 <Location $frontPath/plugins/editor-loader/editor.action>
  Use SecAllowTechnicalArgs
 </Location>
 
 <Location $frontPath/plugins/createcontent/docreatepage.action>
  Use SecAllowHTMLTemplate
  Use SecAllowTechnicalArgs
 </Location>
 
 <Location $frontPath/plugins/servlet/confluence/placeholder/error>
  Use DoNotTrapError 500
 </Location>

 <Location $frontPath/plugins/servlet/saml/auth>
  Use SecAllowURL
 </Location>

 <Location $frontPath/plugins/servlet/view-file-macro/placeholder>
  # Allow arg mimeType=application/x-xmind
  Use SecRuleRemoveById 2000453
 </Location>
 
 <LocationMatch ^$frontPath/(?:pages/|/rest/tinymce)>
  Use SecAllowHTMLTemplate
  Use SecAllowTechnicalArgs
  Use SecAllowWindowsPath
  Use SecArgsAllowCharsetUnicode "24"
 </LocationMatch>
 
 <LocationMatch ^$frontPath(?:/undefined)?/rest/>
  Use SecArgNameAllowEmpty
  Use SecAllowTechnicalArgs
  Use SecAllowURL
  Use SecAllowDotInUrl 
  Use SecAllowHTML
  Use AllowXML
  Use AllowAutomatedTools
 </LocationMatch>
 
 <LocationMatch ^$frontPath/rest/(?:applinks|gadgets|mywork)/>
  Use AllowJavaHttpClient
 </LocationMatch>
 
 # Page editor
 <LocationMatch ^$frontPath/rest/(?:api/content|tinymce)/>
  Use SecArgSizeMax 6000022
  Use SecAllowBackSlash
 </LocationMatch>

 <LocationMatch ^$frontPath/rest/(?:hipchat/integration|scriptrunner-confluence/latest/macros/exec)>
  Use DoNotTrapError 403
 </LocationMatch>

 # From plugin drawio. The diagram is sent to confluence using an xml with a tag 'diagram' with binary base64 encoded content
 <LocationMatch ^$frontPath/rest/drawio/[0-9.]+/diagram/>
  Use SecAllowBase64
 </LocationMatch>

 <LocationMatch ^$frontPath/rest/experimental/relation/touched/from/user/current/to/content>
  Use SecIgnorePageNotFound
 </LocationMatch>

 <LocationMatch ^$frontPath/rest/analytics/[0-9.]+/publish/bulk$>
  Use SecArgsJsonNbNoMax
  Use SecArgNameAllowCharacter ":"
 </LocationMatch>

 # Don't redirect when not authenticated in mod_oidc
 Use SecRule TX:url "/_/plugins/servlet/confluence/placeholder/macro-icon$" "~{Oidc401Action}"
 Use SecRule TX:url "^$frontPath/synchrony(?:-proxy)?/"                     "~{Oidc401Action}"

 <LocationMatch ^$frontPath/synchrony(?:-proxy)?/>
  Use SecAllowAuthCORS
  #Use SecIgnoreCORS
 </LocationMatch>
 <LocationMatch ^$frontPath/synchrony(?:-proxy)?/v[0-9]+/errorlog$>
  #Allow .prototype in arg
  Use SecRuleRemoveById 2000340,2000434
  Use SecAllowTechnicalArgs
 </LocationMatch>
 <LocationMatch ^$frontPath/synchrony(?:-proxy)?/heartbeat$>
  Use SecIgnorePageNotFound
 </LocationMatch>

 <LocationMatch ^$frontPath/~{confl_badJson}>
  Use SecRequestBodyAccess Off
  Use NoReqContentAutodetect
 </LocationMatch>
</Macro>

<Macro Confluence_Proxy @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use Confluence_Proxy_ "" @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro Confluence_ProxySSL @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use Confluence_Proxy_ SSL @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

# https://jira.atlassian.com/browse/CONFSERVER-55981
<Macro Confluence_PluginUrlWhitelisted $frontPath>
 <Location $frontPath/plugins/servlet/confluence/placeholder/error>
  Use SecAllowUrl
 </Location>
</Macro>

# scroll-versions plugin: https://help.k15t.com/scroll-versions/latest/
DefineStr ConfluenceApiRestUrl_ "(?:(?:(?:context|wiki)/)?+rest/(?:api|scroll-versions))"
<Macro ConfluenceApi_Proxy @ssl @frontServer  $frontPath  @protocol @backServer @backPort @backPath>
 Use SecRuleUrlPhase1 "!^/(?:~{ConfluenceApiRestUrl_}|download/attachments|images)/" 6000020 "msg:'This path is not allowed'"
 Use Confluence_Proxy_     @ssl @frontServer "$frontPath" @protocol @backServer @backPort @backPath
 Use SecWebAppId Confluence-api
 Use SecAuditLog "~{SecLog}/../confluence-api_audit.log"
 Use WebAPI
 Use AllowAutomatedTools
</Macro>
<Macro ConfluenceApiRead_Proxy @ssl @frontServer @frontPath  @protocol @backServer @backPort @backPath>
 Use ConfluenceApi_Proxy       @ssl @frontServer @frontPath  @protocol @backServer @backPort @backPath
 Use SecRuleDeny REQUEST_METHOD "!^(?:GET|HEAD)$" "phase:1,msg:'Invalid method'"
</Macro>
