### general purpose defines

DefineStr WAF_CONF_COMMON "20240527"

DefineStr MaxInt   2147483647

# SVG can contain scripts
DefineStr ImagesFileExt       "(?i:avif|djvu|gif|ico|j2[ck]|jfif|jpe?g2?|jp[2cefmx]|mj2|pgf|[mp]ng|svgz?|stills|tiff?|webp)"
DefineStr ArchiveFileExt      "(?i:7z|bz(?:2|ip)|cab|rar|sit|t?gz|zip)"
DefineStr CompressedDocFileExt   "(?i:do[ct]x|dwg|dwfx|dxf|emz|ics|mp[pt]x|od[gpst]|pdf|potx|pp[st]x|vsdx?|xl[st]x)"
DefineStr UncompressedDocFileExt "(?i:csv|do[ct]|eml|emz|msg|mp[dptx]|pot|pp[st]|rtf|tsv|txt|xl[st])"
DefineStr MultiMediaFileExt   "(?i:aac|au|avi|djvu?|dng|f[4l]v|ind[bdt]|km|m2t|m3u8|midi?|mov(?:ie)?|mp[34]|mpe?g|mxf|og[gvx]|pict|qt|qxd|ram?|srt|swf|vtt|xmp|wav|webm|wm[av])"
DefineStr PublishingFileExt   "(?i:ai|eps|ind[bdt]?|qx.?)"
DefineStr CompressedFileExt   "(?i:~{CompressedDocFileExt}|~{ArchiveFileExt}|~{ImagesFileExt}|~{PublishingFileExt}|~{MultiMediaFileExt})"
DefineStr UncompressedFileExt "(?i:bmp|~{UncompressedDocFileExt})"
DefineStr FontFileCExt        "(?i:eot|woff2?)"
DefineStr FontFileUExt        "(?i:odt|[ot])(?i:tf)"
DefineStr FontFileExt         "~{FontFileCExt}|~{FontFileUExt}"
DefineStr UsualFileExt        "(?i:~{UncompressedFileExt}|~{CompressedFileExt}|~{ImagesFileExt}|~{FontFileExt}|~{PublishingFileExt}|~{MultiMediaFileExt})"
DefineStr MacroDocFileExt     "(?i:do[ct]m|mp[dp]|potm|pp[st]m|xl[st]m)"
DefineStr MacroDocFileExtCD   "docm,dotm,potm,ppsm,pptm,xlsm,xltm"
DefineStr UnsupportedCompressedFileExt "(?i:~{MacroDocFileExt}|dmg|[ejsw]ar|hqx|msi|xpi)"
DefineStr TechnicalUpFileExt  "(?i:dtd,log,orc,xoml,saz)"
DefineStr DocFileExt          "(?i:~{CompressedDocFileExt}|~{UncompressedDocFileExt}|~{MacroDocFileExt}|~{ImagesFileExt}|~{MultiMediaFileExt}|~{PublishingFileExt}|~{FontFileExt})"
DefineStr BinaryFileExt       "(?i:axd|binjs|~{DocFileExt}|~{CompressedFileExt}|~{MultiMediaFileExt}|~{PublishingFileExt}|~{FontFileExt}|~{UnsupportedCompressedFileExt}|~{TechnicalUpFileExt})"
DefineStr AllCompressedExt    "(?i:~{CompressedFileExt}|~{FontFileCExt}|~{MultiMediaFileExt}|~{PublishingFileExt}|~{UnsupportedCompressedFileExt})"
DefineStr StaticFileExt       "(?i:css|js|html|~{BinaryFileExt})"
DefineStr UsualResFileExt     "(?i:css|js|~{FontFileExt}|~{ImagesFileExt}|~{MultiMediaFileExt})"

DefineStr MimeStd             "(?:application/x-(?:www-(?:form-url|utf8-)|vermeer-url)encoded|multipart/form-data|text/plain)"
DefineStr MimeJSON            "(?:application/(?:[-.a-zA-Z0-9_]+[+]json|json(?:[+][-.a-zA-Z0-9_]+)?))"
DefineStr MimeJSONSeq         "(?:application/(?:[-.a-zA-Z0-9_]+[+]json-seq|json-seq(?:[+][-.a-zA-Z0-9_]+)?))"
DefineStr MimeSOAP            "(?:application/(?:fastsoap|soap[+]xml))"
DefineStr MimeXML             "~{MimeSOAP}|(?:application/(?:(?:xop|vnd.*)[+])?xml|text/xml)"
DefineStr MimeJSText          "(?:application/(?:x-css|x-javascript)|text/(?:css|javascript))"
DefineStr MimeJSBin           "application/javascript-binast"
DefineStr MimeJS              "(?:~{MimeJSText}|~{MimeJSBin})"
DefineStr MimeHTMLText        "(?:application/x?html|text/html|~{MimeJSText})"
DefineStr MimeHTML            "(?:~{MimeHTMLText}|~{MimeJSBin})"
DefineStr MimeText            "(?:~{MimeStd}|~{MimeJSON}|~{MimeXML}|~{MimeHTMLText}|application/csp-report|application/x-vermeer-rpc|text/)"
DefineStr MimeVnd             "(?:application/vnd[.](?:ms-(?:excel|powerpoint|project|word)|oasis[.]opendocument[.].*|openxmlformats-officedocument[.].*))"
DefineStr MimeDoc             "(?:application/(?:epub+zip|msword|postscript|pdf|rtf)|message/rfc822|text/(?:csv|plain|tab-separated-values)|~{MimeVnd})"
DefineStr MimeDocMacro        "(?:application/vnd[.]ms-(?:excel[.](?:sheet|template)|powerpoint[.](?:presentation|slide)|word).*)"
DefineStr MimeMultiMedia      "(?:(?:audio|image|video)/.*|application/(?:mp[0-9]+|mpeg4-.*|ogg|vnd.adobe[.]flash-movie))"
DefineStr MimeFont            "(?:application/font.*)"
DefineStr MimeArchive         "(?:(?:application|multipart)/(?:x-)?(?:compress(?:ed)?|tar|(?:g|win)?zip(?:-compressed)?|zlib))"
DefineStr MimeBinary          "(?:application/octet-stream)"
DefineStr MimeUsual           "(?:~{MimeDoc}|~{MimeMultiMedia}|~{MimeArchive})"

DefineStr CharMin             "A-Z-a-z0-9._"
DefineStr CharNormal          "#~{CharMin}!$%&\x27()*+,/:;=?@[\]{}~ \x22<>\xc0-\xff"
DefineStr CharUserid          "~{CharMin}+/:@"
DefineStr ISO8859_1Letters    "\xc0-\xf6\xf8-\xff"
# UTF-8 letters (and emojis):
#  Latin: c380-c9bf
#  Greek + Coptic: cfbf
#  Cyrillic: d080-d4a7
#  Arabic & Asian: 3 bytes
#       warning: ca80-cab8 also contains some Latin characters but cabb-cacf contains punctuation characters
#        dashes: e28091-e28095 => e2 also allows .., slashes, etc.
DefineStr UTF8Letters  "\x80-\xbf\xc3-\xc9"
DefineStr UnicodeLetters "~{ISO8859_1Letters}~{UTF8Letters}"
DefineStr CharFreeText   "~{CharNormal}~{UnicodeLetters}\x0a\x0d"
DefineStr CharName       "A-Z-a-z\x27 ~{UnicodeLetters}"
# Also allow ' ???
DefineStr CharFilename "#~{CharMin}!$%&()+,=;@[\]{}~ ~{UnicodeLetters}"
DefineStr ForbiddenCharsFilename "<>*?:|/\x22\x5c"
DefineStr CharPassword "\x20-\x7e~{UnicodeLetters}"
DefineStr QuotedString "(?:\x27[^\x27]*\x27|\x22[^\x22]*\x22)"

DefineStr EndOfFQDN "(?![-_a-zA-Z0-9.])"

# These are also allowed by RFC 2822: !#$%&*/=?^`{}|~
#   and also double-quoted strings containing any character
#   (space, double-quote and ? must be escaped with backslash)
#   but RFC 5321 advise to not use quoted strings
DefineStr syntax_email      "(?i:\b[a-z0-9][-\w.+]{0,63}@(?:[-\w+]{1,30}[.]){1,4}[a-z]{2,12}\b)"
DefineStr syntax_epoch      "[0-9]{1,10}"
DefineStr syntax_day        "(?:\b(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun)(?:day)?)\b"
DefineStr syntax_ipv4       "(?:\b[0-9]{1,3}[.][0-9]{1,3}[.][0-9]{1,3}[.][0-9]{1,3}\b)"
DefineStr syntax_ipv6u      "\b(?:[0-9a-f]{1,4}:){7}[0-9a-f]{1,4}\b"
DefineStr syntax_ipv6c      "[0-9a-f:]*::[0-9a-f:]*"
DefineStr syntax_ipv6r      "\b(?:[0-9a-f]{1,4}:){5}[0-9a-f]{1,4}\b"
DefineStr syntax_ipv6       "(?i:~{syntax_ipv6u}|~{syntax_ipv6c})"
DefineStr syntax_ipv64      "(?i:~{syntax_ipv6r}|~{syntax_ipv6c}):~{syntax_ipv4}"
DefineStr syntax_ip         "(?:~{syntax_ipv4}|~{syntax_ipv6}|~{syntax_ipv64})"
DefineStr syntax_GUID       "(?:[0-9a-fA-F-]{0,100}\b)"
DefineStr syntax_phone      "(?:(?:[+]?[0-9]{2,3})?\s{1,2}(?:[(][0-9]{1,5}[)])?[0-9.:\s-]{1,15}\b)"
DefineStr syntax_base64     "(?:[-_a-zA-Z0-9+/]*={0,2})"
DefineStr syntax_base64NL   "(?:[-_a-zA-Z0-9+/\x0a\x0d]*={0,2}[\x0a\x0d]*)"
DefineStr HostChars_        "-_a-zA-Z0-9"
DefineStr HostChars         "[~{HostChars_}.]"
DefineStr syntax_URL_host   "(?:~{HostChars}{1,80}(?::[0-9]{1,5})?)"
DefineStr syntax_URL_path   "(?:/(?:[+~{CharMin}/@%, <>]*))?"
DefineStr syntax_URL_scheme  "(?:(?:(?:android-app|applewebdata|https?):)?//~{syntax_URL_host})"
DefineStr syntax_URL_sscheme "(?:(?:(?:android-app|applewebdata|https):)?//~{syntax_URL_host})"
DefineStr syntax_URL_full   "(?:~{syntax_URL_scheme}~{syntax_URL_path})"
DefineStr syntax_URL        "(?:~{syntax_URL_full}|~{syntax_URL_path})"
DefineStr syntax_URL_quoted "(?:(?:(?:(?:android-app|https?):)?//~{syntax_URL_host})?(?:/[^\x27\x22]*)?)"
DefineStr syntax_URL_https  "(?:~{syntax_URL_sscheme}~{syntax_URL_path}?|~{syntax_URL_path})"
DefineStr syntax_QueryStr   "(?:[?][~{CharNormal}]*)?(?:#[~{CharNormal}]{0,~{RequestLengthMax}})?"
DefineStr syntax_URL_Query  "(?:~{syntax_URL}~{syntax_QueryStr})"
DefineStr syntax_URL_https_Query  "(?:~{syntax_URL_https}~{syntax_QueryStr})"
DefineStr syntax_lang_rfc5646 "^[a-zA-Z- ]*$"
DefineStr syntax_uuid       "(?:[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})"

# ...::1 used by many IPv6 addresses => don't check in regex in middle of string
DefineStr IpLocalHostRegex    "(?:\b127[.]0[.]0[.]1\b|^::1$)"
DefineStr IpCGNInternalRegex_ "\b(?:100[.](?:(?:6[4-9]|[7-9][0-9]|11[0-9]|12[0-7])(?:[.][0-9]{1,3}){2}))\b"
DefineStr IpInternalRegex_    "\b(?:10[.][0-9]{1,3}|192[.]168|172[.](?:1[6-9]|2[0-9]|3[01]))(?:(?:[.][0-9]{1,3}){2})\b"
DefineStr IpInternalRegex     "(?:~{IpLocalHostRegex}|~{IpInternalRegex_}|~{IpCGNInternalRegex_})"
DefineStr LocalHostRegex      "(?:\blocalhost\b|~{IpLocalHostRegex})"
DefineStr IpLocalhost         "127.0.0.1,::1"
# IpInternal is used as a regex by some customers => trick for compatibility
DefineStr IpInternal_         "~{IpLocalhost},10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,100.64.0.0/10"
DefineStr IpInternal          "~{IpInternal_}"
DefineStr IpAll               "0.0.0.0/0"
<IfDefine !IpMatch>
 DefineStr IpInternal         "~{IpInternalRegex}"
 DefineStr IpAll              ".*"
</IfDefine>

#DefineStr sessionCookie  "^(?:asp(net_)?sessionid[a-z]*|phpsess(?:ion)id|(?:cms|j(?:serv|vb_|w)session))"
DefineStr sessionCookie  "(?<!~{OIDCCookiePrefix})sessi(?:d|on)"

DefineStr PublicCacheTime     600

# Default counter time-out (last user, etc.) in seconds
#DefineStr counter_timeout    600
# IP collection time-out
DefineStr ip_timeout         3600
# URL collection time-out
DefineStr res_timeout         600
# Attacks counters time-out
DefineStr block_timeout      7200
# Attacks counters blocking phase (2 allows to check whole request before blocking
DefineStr block_phase   1

DefineStr maxHeuristic  5

# Log at least once per day
DefineStr LogOncePeriod 86400

# RequestReadTimeout header/body=t1[-t2],MinRate=b
#   t1 = time-out for first bytes (including TLS re-negotiation for body)
#   t2 = total time-out (must be > t1)
#   b  = # of bytes that allow 1 more second to t1
DefineStr RequestReadTimeoutMinRate   "MinRate=1024"
DefineStr RequestReadTimeoutHandshake " "
<IfVersion >= 2.4.39>
 DefineStr RequestReadTimeoutHandshake "handshake=5-10,~{RequestReadTimeoutMinRate}"
</IfVersion>
DefineStr RequestReadTimeout                                   "header=3-8,~{RequestReadTimeoutMinRate}   body=3-5,~{RequestReadTimeoutMinRate}"
DefineStr RequestReadTimeoutTLS "~{RequestReadTimeoutHandshake} header=3-8,~{RequestReadTimeoutMinRate} body=10-11,~{RequestReadTimeoutMinRate}"

# Modsecurity internals --------------------------------------------------------

DefineStr   ResponseBodyAccess   "~{nosecaction},tag:security,tag:ResponseBodyAccess,ctl:ResponseBodyAccess=on,setvar:!tx.noResponseBodyAccess"
DefineStr noResponseBodyAccessP3 "~{nosecaction},tag:security,tag:ResponseBodyAccess,ctl:ResponseBodyAccess=off"
DefineStr noResponseBodyAccess   "~{noResponseBodyAccessP3},setvar:tx.noResponseBodyAccess"

# dummy value => no real action unless -DEXTENDEDSTATUS
DefineStr countersSetEnv   "tag:@"
<IfDefine MODDEFINE_EmptyValue>
 DefineStr countersSetEnv   ""
</IfDefine>
DefineStr ruleSetEnv       ~{countersSetEnv}
DefineStr denySetEnv       tag:security
# for troubleshooting: DefineStr denySetEnv       "tag:security,setvar:IP.lastrule=%{rule.id},setvar:IP.lastruleMsg=%{rule.msg},setvar:IP.lastruleURL=%{TX.url}"
DefineStr denyUnSetEnv     ~{countersSetEnv}
DefineStr noIncreaseBlockCounter "initcol:IP=none"
<IfDefine ClientStatus>
 DefineStr countersSetEnv  "setenv:waf-IP-blocked=%{IP.blocked},setenv:waf-SESSION-blocked=%{SESSION.blocked},setenv:waf-IP-BadAuth=%{IP.BadAuth},setenv:waf-IP-UPDATE_COUNTER=%{IP.UPDATE_COUNTER},setenv:waf-IP-LAST_UPDATE_TIME=%{IP.LAST_UPDATE_TIME},setenv:waf-IP-UPDATE_RATE=%{IP.UPDATE_RATE}"
 DefineStr ruleSetEnv      "setenv:'BlockRuleId=%{ENV.BlockRuleId}|%{rule.id}|',setenv:'BlockStatus=%{ENV.BlockStatus}|%{rule.status}|',setenv:'LastSecMsg=%{env.LastSecMsg}|%{rule.msg}',setenv:'LastSecData=%{env.LastSecData}%{MATCHED_VAR_NAME}=%{MATCHED_VAR}|',setvar:'GLOBAL.LastMsg=%{rule.msg}'"
 DefineStr denySetEnv      "tag:security,~{ruleSetEnv},setenv:noIncreaseBlockCounter"
 DefineStr denyUnSetEnv    "setenv:'BlockRuleId=%{ENV.BlockRuleId}|-%{rule.id}|',setenv:'LastSecMsg=%{env.LastSecMsg}|-%{rule.msg}',setenv:'LastSecData=%{env.LastSecData}-%{MATCHED_VAR_NAME}=%{MATCHED_VAR}|'"
 DefineStr noIncreaseBlockCounter   "initcol:IP=none,setenv:noIncreaseBlockCounter"
</IfDefine>
DefineStr increaseBlockCounter     "initcol:IP=none,setvar:tx.blocked,~{denySetEnv}"
###,initcol:SESSION=none
DefineStr increaseBlockCounterMax  "~{increaseBlockCounter},setvar:tx.blocked=9999"
DefineStr increaseAuthCounter      "~{increaseBlockCounter},setvar:tx.BadAuth"
DefineStr decreaseBlockCounter     "setvar:!tx.blocked,severity:255,~{noErrorHeader}"
DefineStr fixBlockCounter          "~{decreaseBlockCounter},~{denyUnSetEnv}"
DefineStr allRules                 "1-999999999"
DefineStr disableAllRules          "ctl:ruleRemoveById=~{allRules},ctl:ruleRemoveByTag=security"
DefineStr denyOnNextLine           "~{denyUnSetEnv}"
# transformations
DefineStr ascii            none
DefineStr utf2ascii        utf8toUnicode,t:urlDecodeUni
# Warning: urlDecode(Uni) decodes %... but also +, which is applicable to
# application/x-www-form-urlencoded & query parameters only (names & values)
DefineStr url              none,t:urlDecode
DefineStr urlUnicode       none,t:~{utf2ascii}
<IfDefine MODSEC_TFN_urlEncodePlus>
 DefineStr url             none,t:urlEncodePlus,t:urlDecode
 DefineStr urlUnicode      none,t:urlEncodePlus,t:~{utf2ascii}
</IfDefine>
<IfDefine MODSEC_TFN_utf2ascii>
 DefineStr utf2ascii        utf8toAscii
</IfDefine>
#DefineStr addHtmlDecode    htmlEntityDecode
#DefineStr addJsDecode      ~{addHtmlDecode},t:jsDecode
#DefineStr addCssDecode     ~{addHtmlDecode},t:cssDecode,t:jsDecode
# HTML decoding is so incomplete, don't use it
#DefineStr htmlDecode_      none,t:urlEncodePlus,t:urlDecode,t:~{addHtmlDecode}
DefineStr htmlDecode_      none,t:urlDecode
DefineStr htmlDecode       ~{htmlDecode_},t:~{utf2ascii}
# utf2ascii is incomplete (only Unicode-16 4 bytes) and slow 
DefineStr encodedParam     ~{htmlDecode}
DefineStr jsDecode         ~{htmlDecode_},t:jsDecode,t:~{utf2ascii}
DefineStr cssDecode        ~{htmlDecode_},t:cssDecode,t:jsDecode,t:~{utf2ascii}
# linefeed ignored inside strings
#DefineStr jsDecodeAttr    ~{cssDecode},t:removeCRLF
DefineStr shellDecodeWin   ~{htmlDecode},t:cmdLine,tag:OSShell,tag:security,tag:Command,tag:CmdWin
DefineStr shellDecodeUnix  ~{htmlDecode},t:bash,tag:OSShell,tag:security,tag:Command,tag:CmdUnix
# \ are not well supported (stripped in bash)
# potentially misses boundaries in Windows  (quotes stripped in bash)
DefineStr shellDecode      ~{shellDecodeUnix}
<IfDefine NoBashTfn>
 DefineStr shellDecodeUnix  ~{shellDecodeWin}
</IfDefine>
DefineStr winPathDecode    ~{htmlDecode_},t:normalisePathWin,tag:security
DefineStr sqlDecode        ~{encodedParam},t:sqlHexDecode,tag:SQL,tag:security
DefineStr sqlNormalize_    ~{sqlDecode}
<IfDefine !NoNormalizeSqlTfn>
 DefineStr sqlNormalize_   urlDecode,t:htmlEntityDecode,t:normalizeSql,tag:SQL,tag:security
</IfDefine>
DefineStr sqlNormalize           none,t:~{sqlNormalize_}
DefineStr sqlNormalizeNoComment  none,t:replaceComments,t:~{sqlNormalize_}
DefineStr caseSensitive    "tag:case"
# not base64 as / and + pose problems at some places
DefineStr hash             "t:sha1,t:hexEncode"
DefineStr hashShort        "t:md5,t:hexEncode"

DefineStr attrSeparator "[ /\x27\x22]"
#DefineStr attrSeparator "[[ /\x27\x22!#$&*()+-~_.:;?@|^`]]"

DefineStr AbsUrlEnd    "(?:[/;><%|\s\x22\x27\x5c?#]|$)"

DefineStr encodedDot          "(?:[.]|(?:%|[\x5c]+u00)(?:25)?(?i:2e))"
DefineStr encodedSemiColon    "(?:[:]|(?:%|[\x5c]+u00)(?:25)?(?i:3a))"
DefineStr encodedSlash        "(?:[\x5c]?[/]|(?:%|[\x5c]+u00)(?:25)?(?i:2f))"
DefineStr encodedSemiColonSlashSlash "(~{encodedSemiColon}~{encodedSlash}{2})"
DefineStr encodedHttp         "(?:\bhttp~{encodedSemiColonSlashSlash})"
DefineStr encodedHttps        "(?:\bhttps~{encodedSemiColonSlashSlash})"
DefineStr encodedHttpx        "(?:\bhttps?~{encodedSemiColonSlashSlash})"

# Normally only 1 space is allowed, no more (and tab isalso allowed, but not used concretely)
DefineStr CT_MimeType     "[a-z]+(?:/[a-z0-9-+.]+)?"
DefineStr CT_Charset      "(?: *; *charset=(?<quote_ct>\x22?)[a-z0-9-]+\k<quote_ct>)?"
DefineStr CT_ParamToken   "(?:[a-z0-9-_+./]+|\x22[^\x22]+\x22)"
DefineStr CT_ParamEncoded "(?:\x27\x27(?:[a-z0-9-_+./%]+|\x22\x27\x27[^\x22]+\x22))"
DefineStr CT_ParamsUrn    "(?:(?:action|profile)=\x22(?:~{syntax_URL_Query}|urn:[:/+~{CharMin}]+)\x22)"
DefineStr CT_ParamsAny    "(?:(?:codecs|profiles)=~{CT_ParamToken}|(?:codecs|profiles)[*]=~{CT_ParamEncoded})"
DefineStr CT_Params       "(?: *; *(?:~{CT_ParamsUrn}|~{CT_ParamsAny}))*"
DefineStr CT_Multipart    "multipart/form-data *; *boundary=(\x22?)[a-z0-9-_]+\1"
DefineStr CT_Full         "(?i)^(?:~{CT_Multipart}|~{CT_MimeType})~{CT_Charset}~{CT_Params} *$"

DefineStr ContentNeg_Q     "(?: *; *q=(?:0|1(?:[.]0)?|0[.][0-9]{0,3}))? *(?=,|$)"
DefineStr ContentNeg_Q0    "(?: *; *q=0(?=[ ,]|$))"
DefineStr ContentNeg_Q1    "(?: *; *q=(?:1(?:[.]0)?|0[.][0-9]{0,3}))? *(?=,|$)"
#Accept-Encoding:         compress|deflate|gzip|br|identity|[*]|bzip2?
#Content-Encoding (req):  compress|deflate|gzip
#Content-Encoding (resp): compress|deflate|gzip|br|identity|none
#TE:                      compress|deflate|gzip|br|bzip2?|trailers
DefineStr ContentNeg_CompressBasic_     "(?i:\bbr\b|compress|deflate|gzip)"
DefineStr ContentNeg_Compressed_        "~{ContentNeg_CompressBasic_}|(?i:bzip2?|sdch|snappy)"
DefineStr ContentNeg_CompressAll_       "~{ContentNeg_Compressed_}|(?i:identity)"
DefineStr ContentNeg_CompressSupported  "(?:~{ContentNeg_CompressBasic_})"
DefineStr ContentNeg_CompressedResponse "(?:~{ContentNeg_CompressBasic_})"
DefineStr ContentNeg_CompressAccepted   "(?:~{ContentNeg_CompressAll_}|[*]|(?i:aes128gcm|base64|exi|none|peerdist|x-gzip|zstd))"

DefineStr WebDavClient_Frontpage "auth/sicily|MS FrontPage"
DefineStr WebDavClient_MSOffice  "^Microsoft(?:-WebDAV-MiniRedir| Office |.*Protocol Discovery)|(?i:ms-?office(?!.*outlook))|^Onenote/|^Word/"
DefineStr MSWebDavClient "~{WebDavClient_Frontpage}|~{WebDavClient_MSOffice}|(?:Libre|Open)Office"


DefineStr CspHeader      "Content-Security-Policy"
DefineStr CspHeaderDebug "Content-Security-Policy-Report-Only"
# Allow blob: because the blob needs to be creatÿ  b绵ore => XSS already performed
DefineStr cspSelf "'self' blob:"

# 307 are not working with IE & caching, 308 is never followed by IE
DefineStr redirect308   301

# default values overwritten in params.conf -----------------------------------------------------------------------

DefineStr ApacheGroup            apache
DefineStr ApacheUser             apache

DefineStr ServerName             -
DefineStr ServerEmail            unset@unset.com
DefineStr IncidentServerName     -
DefineStr IncidentServerId       -
DefineStr ServerId               "~{ServerName}/~{IncidentServerName}/~{IncidentServerId}"
DefineStr AdditionalServerNames  ^@
DefineStr ServerBanner           ~{ServerName}
DefineStr SecRuleEngine          on
DefineStr SecResponseBodyAccess  on
DefineStr DoSAttackMax               10
DefineStr DoSConnectionNb          1000
DefineStr DoSConnectionRate        1000
DefineStr DoSConnectionRateLog      100
DefineStr SSLSessionTimeout         300
DefineStr SSLSessionCacheSize    512000

# Load balancer: number of errors before disconnecting a backend
DefineStr LBMaxErrors                 3
# Load balancer: number of seconds before reconnecting a failed backend
DefineStr LBRetryTime                60
DefineStr BackEndRetryTime ~{LBRetryTime}

DefineStr MaxRange                   20
DefineStr MonitoringIP           127.0.0.1
DefineStr ProbeIP                127.0.0.1
DefineStr EmergencyProbeIP       127.0.0.1
<IfDefine !IpMatch>
 DefineStr ProbeIP_               "~{ProbeIP}|~{EmergencyProbeIP}"
</IfDefine>
<IfDefine IpMatch>
 DefineStr ProbeIP_               "@IpMatch ~{ProbeIP},~{EmergencyProbeIP}"
</IfDefine>
DefineStr ProbeURL               "(?:^/probe(?:/|$))"
DefineStr EmergencyProbeURL      $^
DefineStr ProbeURL_              "~{ProbeURL}|~{EmergencyProbeURL}"
DefineStr IpToIgnore             127.0.0.1
DefineStr ReverseProxy_IP        127.0.0.1
DefineStr App_WAF_Front_IP       127.0.0.1
<IfDefine !IpMatch>
 DefineStr WAF_RP_IP_Check "^(?:~{App_WAF_Front_IP})$"
 DefineStr RP_IP_Check     "^(?:~{App_WAF_Front_IP}|~{ReverseProxy_IP})$"
</IfDefine>
<IfDefine IpMatch>
 DefineStr WAF_RP_IP_Check "@IpMatch ~{App_WAF_Front_IP}"
 DefineStr RP_IP_Check     "@IpMatch ~{App_WAF_Front_IP},~{ReverseProxy_IP}"
</IfDefine>
DefineStr Ip_ApproachRegex       "(?:81[.]243[.]240[.]179|104[.]40[.]205[.]115)"
DefineStr Ip_Approach            "81.243.240.179,104.40.205.115"
<IfDefine !IpMatch>
 # 100.64.0.0/10 => 100.64.0.0 to 100.127.255.254
 DefineStr Ip_AlibabaVPC         "100[.](?:6[4-9]|[789].|1[01].|12[0-7])[.].*"
 DefineStr Ip_AlibabaMonitor     "14[.]1[.]11[2-5].*|170[.]33[.].*"
</IfDefine>
<IfDefine IpMatch>
 DefineStr Ip_AlibabaVPC         "100.64.0.0/10,7.0.0.0/8,8.0.0.0/6"
 DefineStr Ip_AlibabaMonitor     "14.1.112.0/24"
</IfDefine>
DefineStr WAF_admin_ip           127.0.0.1
DefineStr EmergencyWafAdminIp    127.0.0.1
DefineStr EmergencyAppAdminIp    127.0.0.1
DefineStr EmergencyIpToNotBlock  127.0.0.1
DefineStr IpPublish              127.0.0.1
DefineStr CompressedResourceDir  ^@$
DefineStr AdditionalLogActions   auditlog
DefineStr VulnScanLogActions     ~{nolog}
DefineStr BackendIdHeader        X-Backend

DefineStr ConcurrentConnections 25

DefineStr DefaultVhostPort      80
DefineStr DefaultSSLVhostPort  443
Define    DefaultPort80          1
Define    DefaultPort443         1
Define    Warnhttp443            1
Define    Warnhttps80            1
Define    Is11                   1
Define    Is00                   1

DefineStr HSTSMaxAge  31536000

DefineStr WinCmdDelimShort   "[&|]"
DefineStr UnixCmdDelimShort  "[&|;]"
DefineStr CmdDelimShort      "~{UnixCmdDelimShort}"
DefineStr WinCmdDelim        "(?:~{WinCmdDelimShort}.*\b)"
DefineStr UnixCmdDelim       "(?:~{UnixCmdDelimShort}.*\b)"
DefineStr CmdDelimShort      ~{UnixCmdDelimShort}
DefineStr CmdDelim           ~{UnixCmdDelim}


# IP blocking (time in seconds)
DefineStr BadAuthMax           5
DefineStr BadAuthDecrease      1/600
DefineStr BlockedMax           10
DefineStr BlockedDecrease      1/600
DefineStr BlockedNoWarn        5000

SetEnv WAF_CONF_APP    -
Setenv WAF_CONF_CUSTOM -

# ================== System paths ==================================
# Custom paths - default to be overwritten if needed
DefineStr ErrorLog        "~{LogRoot}/error.log"
DefineStr AccessLog       "~{LogRoot}/access.log"
DefineStr RewriteLog      "~{LogRoot}/rewrite.debug"
DefineStr SecLog          "~{LogRoot}/security/audit.log"
DefineStr SecDebugLog     "~{LogRoot}/security/audit.debug"
DefineStr ScriptPath      "~{ConfPath}/common/scripts"

# ================== Security - system  limits =====================
# Maximum length of a URI + method, ... (limited in rules.conf)
DefineStr LimitRequestLine           8189
# Maximum number of headers in a request (limited in rules.conf)
DefineStr LimitRequestFields           99
# Maximum length of headers in a request (limited below)
DefineStr LimitRequestFieldSize     32768

DefineStr RequestLengthMax           5120
DefineStr MaxHeaders                   50
DefineStr HeaderNameMax                64
DefineStr HeaderLengthMax            2048
DefineStr MaxCookies                  100
DefineStr CookieNameMax                80
DefineStr CookieLengthMax             550
# Cookies limits in browsers: http://browsercookielimits.squawky.net/

DefineStr ArgsNameLengthMax            80
# Not used for JSON/XML
DefineStr ArgsNbSameName               20
# Nested JSON objects/arrays names are concatenated => 50 x 10 levels
# (IBM JSON parser support 256 x 64)
DefineStr ArgsJsonNameLengthMax       500
DefineStr ArgsMax                      30
DefineStr ArgsJsonMax                1000
DefineStr ArgsSizeMax                8000
DefineStr ArgsTotalSizeMax        6000000
DefineStr ReqBodyNoFilesSizeMax   8000000
DefineStr ReqBodySizeMax        134217728

DefineStr UserNameSyntax    -
DefineStr UserNameLengthMax -
DefineStr PasswordLengthMax            64

# Max file system path: Windows=260, Linux=4095
DefineStr FilePathLengthMax           259
DefineStr UploadFileNameLengthMax      80
DefineStr UploadFileNbMax               1
DefineStr UploadFileSizeMax       2000000
DefineStr UploadTotalFileSizeMax  2000000

DefineStr MaxResponseLengthToAnalyse 50000

# ================== Logs ==================================
DefineStr AccessLogType         Approach
# LogLevel: debug, info, notice, warn, error, crit, alert, or emerg
DefineStr LogLevel             warn

# Log or not requests for images, CSS, ...: "yes" or "no"
DefineStr LogImages            no
DefineStr LogResources         no
DefineStr LogProbe             no

# Max request body size to log C section
DefineStr MaxReqSizeC 50000

# Min/Max size for compression
DefineStr CompressSizeMin    1000
DefineStr CompressSizeMax  120000

DefineStr UseOCSP               Off

# Also X-Originating-IP, CF-Connecting-IP 
DefineStr IPAddressHeader   X-Forwarded-For

# Protocols accepted in all vhosts
DefineStr  Protocols      "http/1.1"
DefineStr  ProtocolsRegex "^HTTP/(?:1[.][01])$"
<IfModule http2_module>
 DefineStr Protocols      "h2 http/1.1"
 DefineStr ProtocolsRegex "^HTTP/(?:1[.][01]|2[.]0)$"
</IfModule>


#   TLS/SSL Cipher Suite: ciphers that the client is permitted to negotiate.
#   References:
#     - https://wiki.mozilla.org/Security/Server_Side_TLS
#     - http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html
#     - https://caniuse.com/#feat=tls1-2&feature_sort=usr_score
#     - https://dev.ssllabs.com/ssltest/clients.html
#   TLSv1.0 needed by Java 7, OpenSSL 0.9.x, IE 7 (not enabled by default in 8-10), Safari 6.x, iOS Safari 4.x, Android 4.x...
#   Encryption:
#     - Best: GCM (TLS1.2)
#     - non-GCM needed for IE 11 on Win 7/8.1 
#     - AES 128 better than 256: secure enough, faster (Intel support AESNI)
#     - AES: vulnerable to BEAST before TLS1.1
#     - To enforce min. 2048 bits: :@SECLEVEL=2 (https://www.openssl.org/docs/manmaster/ssl/SSL_set_security_level.html)
#     - still in research: CHACHA20-Poly1305?
#     - discussion CHACHA20 vs. AES128 vs. AES256: https://wiki.mozilla.org/Security/Server_Side_TLS#Intermediate_compatibility_.28default.29
#   Hash
#     - SHA256 long enough
#     - with GCM, SHAxxx is only used for internal random (but still used client-side)
#     - SHA (SHA-1) still needed for Java 7, Safari 6, OpenSSL 0.9.x, Android 4.3
#   Signature:
#     - EC much quicker
#   Key exchange:
#     - DHE: not supported by Windows XP
#     - DHE: needed for "forward secrecy"
#     - DHE: 3 times slower if not with EC
#     - RSA: vulnerable to ROBOT attack but required by some load-balancers (ex: Cisco ACE)
#     - DH: 2048 bits => compatibility problems with IE < 11 but it supports ECDHE => prioritise
#     - DH: 2048 bits => compatibility problems with Java 7  but it supports ECDHE => prioritise
#     - DH: 2048 bits => compatibility problems with Java 6 (http://httpd.apache.org/docs/2.4/ssl/ssl_faq.html#javadh)
#   Best and most efficient: ECDHE + ECDSA + AES + GCM (TLS1.2)
#   (E)DH more important than GCM & SHA -> https://wiki.mozilla.org/Security/Server_Side_TLS
# SSLVerifyClient in locations incompatible with TLS 1.3 (some browsers don't support Post-Handshake Authentication)
#  https://bz.apache.org/bugzilla/show_bug.cgi?id=64263
#  SSLProtocol cannot be set at location level => disable TLS1.3 at vhost level
# In TLS 1.3, TLS_CHACHA20_POLY1305_SHA256 is always enabled

# TLS1.3 seems slower in 2.4.53 => remove it
#DefineStr SSLProtocol           "-ALL +TLSv1.3 +TLSv1.2 +TLSv1.1 +TLSv1"
DefineStr SSLProtocol           "-ALL +TLSv1.2 +TLSv1.1 +TLSv1"

DefineStr TLSObsoleteAuth       "-SRP:-PSK:!aDH:-DSS"
DefineStr TLSObsoleteHash       "!MD5:!RC4:-SHA"
DefineStr TLSObsoleteEnc        "-3DES:-CAMELLIA:-IDEA:-SEED:-GOST:-ARIA:-AESCCM"
DefineStr TLSObsoleteCiphers    "!aNULL:!eNULL:!EXP:~{TLSObsoleteAuth}:~{TLSObsoleteHash}:~{TLSObsoleteEnc}"
DefineStr TLSWeakCiphers        "!LOW:-kRSA:-AESCCM:~{TLSObsoleteCiphers}"
DefineStr TLSNewCiphers12       "kEECDH+ECDSA+CHACHA20:kEECDH+CHACHA20:kECDH+CHACHA20:kEDH+CHACHA20:CHACHA20:~{TLSWeakCiphers}"
DefineStr TLSCiphers12          "ECDHE-ECDSA-AES128-GCM-SHA256:kEECDH+ECDSA+AESGCM:ECDHE-RSA-AES128-GCM-SHA256:kEECDH+AESGCM:kEDH+AESGCM:kECDH+AESGCM:kDH+AESGCM:EECDH+AESGCM:EDH+AESGCM:~{TLSWeakCiphers}"
DefineStr TLSCiphers10          "~{TLSCiphers12}:ECDHE-ECDSA-AES128-SHA:kEECDH+ECDSA:ECDHE-RSA-AES128-SHA:kEECDH:DHE-RSA-AES128-SHA:kEECDH+AES:kEDH+AES:kECDH+AES:kDH+AES:EECDH+AES:EDH+AES"
DefineStr SSLCipherSuite        "-ALL:~{TLSCiphers12}"
DefineStr AdditionalSSLCipherSuite "!MD5"

DefineStr ProxyPassParams      "keepalive=on retry=~{LBRetryTime}"
DefineStr ProxyPassParamWS     "upgrade=websocket"
DefineStr BalancerParams       "maxattempts=~{LBMaxErrors}"
DefineStr BalancerMemberParams ""
# To allow response header > 8192: responsefieldsize=16000

Include conf/common/ignored_parts.conf

#DefineStr UNIQUE_ID "~{IncidentServerName}/~{IncidentServerId}/%{timestamp}e/%{UNIQUE_ID}e/%{WORKER_NUM}e-%{WORKER_HASH}e"
DefineStr UNIQUE_ID "expr=~{IncidentServerName}/~{IncidentServerId}/%{TIME_YEAR}%{TIME_MON}%{TIME_DAY}%{TIME_HOUR}%{TIME_MIN}%{TIME_SEC}/%{reqenv:UNIQUE_ID}/%{reqenv:WORKER_NUM}-%{reqenv:WORKER_HASH}/~{WAF_CONF_COMMON}/%{reqenv:WAF_CONF_APP}"

# in micro-seconds
DefineStr SlowRuleTH      400
DefineStr VerySlowRuleTH 1000

DefineStr PseudoRnd "~{ServerName}~{IncidentServerName}~{TrustedDomains}~{TrustedHosts}~{ServerEmail}~{ServerBanner}~{UserNameSyntax}~{UserNameLengthMax}~{PasswordLengthMax}~{UploadFileSizeMax}~{BackendResponseTimeMax}~{CompressSizeMax}~{WAF_admin_ip}~{IpToIgnore}~{ProbeURL}~{ReverseProxy_IP}"

DefineStr  Phase5Warn 5
<IfDefine ClientStatus>
 DefineStr Phase5Warn 3
</IfDefine>

DefineStr NoLogC_    "ctl:auditLogParts=-CGI,ctl:auditLogParts=+J,setvar:TX.logReqBodyBegin"

DefineStr PublishUrl      "/__restricted/publish"
DefineStr PublishCgi      "/__restricted/cgi-bin/publish.cgi"
DefineStr PublishLog      "/__restricted/waf-publish"
DefineStr PublishUrlLog   "^/__restricted/(?:waf-)?publish(?:/|$)"

<IfDefine ForceMockApi>
 DefineStr MockServer 127.0.0.1
 DefineStr MockPort   8083
 DefineStr MockPath   "/api/endpoint"
</IfDefine>
