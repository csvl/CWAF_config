# Rules for DB
# ---------------------------------------------------------------
# Range: 4003300-4003399


<Macro DBCommon_>
 # Disable warning about DB
 Use SecRuleRemoveByID 1000106

 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByFullTag DBAll
 
 Use SecRuleResponse "sql error"  "4003384,tag:Output/Exception,tag:SQL"
</Macro>

<Macro DBSqlServer>
 Use DBCommon_

 Use SecRuleSQLHeuristic "(?i)\b(?:sp|xp|sql)_[a-z]"                              4003316,tag:DBAll,tag:SHORT,tag:Underscore 1
 Use SecRuleArgsCookies  "(?i)sp_(?:addextendedproc|oacreate|oamethod|password|makewebtask)" 4003317,tag:SQL,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies  "(?i)xp_(?:execute|enumdsn|filelist|availablemedia|cmdshell|numkeys|reg(read|write|deletekey|enumvalues|deletevalue|(add|remove)multistring|availablemedia|dirtree|enumdsn|loginconfig|makecab|ntsec_enumdomains|terminate_process))" 4003318,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies  "(?i)exec master"                                        4003319,tag:DBAll ""
 Use SecRuleArgsCookies  "(?i)sysxlogins"                                         4003320,tag:DBAll ""
 Use SecRuleArgsCookies  "(?i)routine_definition|information_schema[.]routines"   4003321,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies  "(?i)sys(?:comment|filegroups|objects|processes|tables|types)" 4003322,tag:DBAll ""
 Use SecRuleArgsCookies  "(?i)master[.]dbo|sysdatabases"                          4003323,tag:DBAll ""
 Use SecRuleArgsCookies  "(?i)open(?:datasource|rowset)|sqloledb|dbmssocn"        4003325,tag:DBAll ""
 Use SecRuleArgsCookies  "(?i)master[.][.]"                                       4003326,tag:DBAll ""
 Use SecRuleArgsCookies  "(?i)\bsp_password\b"                                    4003327,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies  "(?i)msys(?:aces|columns|queries|relationships)"         4003328,tag:DBAll,tag:PossibleName ""
 Use SecRuleArgsCookies  "(?i)\bexec .*[sx]p_"                                    4003324,tag:DBAll,tag:SHORT,tag:Underscore ""
 Use SkipAfterOnSuccess 4003324,tag:security,tag:SQL,tag:DBAll,tag:SHORT,tag:Underscore AfterExecXp
  Use SecRuleArgsCookies "(?i)\bexec [xs]p_"                                      4003348,tag:DBAll,tag:Underscore ""
 Use SecMarker AfterExecXp,tag:security,tag:SQL,tag:DBAll,tag:SHORT,tag:Underscore
 Use SecRuleResponse         "unclosed quotation mark"                            4003330,tag:DBAll,tag:SQL,tag:Output/Exception
</Macro>

<Macro DBMySql>
 Use DBCommon_
 
 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByFullTag "DBAll|SQLStackedQuery"
 Use SecRuleArgsCookies "(?i)\bmysql"                                           4003307,tag:DBAll,tag:SHORT,tag:PossibleName ""
 Use SecRuleSubsetOf 4003307,tag:security 4003347
 Use SecRuleSubsetOf 4003364,tag:security 4003365
 Use SecRuleArgsCookies "(?i)\bmysql_"                                          4003347,tag:DBAll ""
 Use SecRuleArgsCookiesSQL "create (?:definer|event) .{0-100}on schedule"       4003335 tag:DBAll ""
 Use SecRuleArgsCookiesSQL "on duplicate key update"                            4003336 tag:DBAll ""
 Use SecRuleArgsCookiesSQL "load data (?:low_priority|concurrent|local|infile)" 4003337 tag:DBAll ""
 Use SecRuleArgsCookiesSQL "\bset global [a-z0-9_]+ ?="                         4003338 tag:DBAll,tag:Equal ""
 Use SecRuleSubsetOf 2002101,tag:security,tag:SQL,tag:DBAll,tag:Slash,tag:Star,tag:Exclam 4003339
 #Use SecRuleSubsetOf 2002102,tag:security,tag:SQL,tag:DBAll,tag:Slash,tag:Star,tag:Exclam 4003370
 Use SecRuleArgsCookiesSQL "/[*]!"                                              4003339 tag:DBAll,tag:Slash,tag:Star,tag:Exclam "msg:'MySQL conditional command'"
 Use SecRuleArgsCookies "(?i)\brlike\b"                                         4003349,tag:SQL,tag:DBAll,tag:SHORT ""

 # # (comment)
 Use SecRuleSQLHeuristic  "(?<!&)#(?! ? [0-9]+\b)"                             4003341,tag:DBAll,tag:HashTag 1
 Use SecRule &TX:heur4003341 "@eq 0" "phase:2,~{skipAfter}:AfterSqlSComment,id:4003341,tag:DBAll,tag:HashTag,tag:security,tag:SQL"
  Use SecRuleSQLHeuristic "(?<!&)#(?! ? [0-9]+\b)[^\r\n]*[\r\n]"               4003342,tag:DBAll,tag:HashTag 1
 Use SecMarker AfterSqlSComment,tag:security,tag:SQL,tag:DBAll,tag:HashTag

 # Information leakage
 Use SecRuleResponse "error in your SQL syntax"   4003301,tag:DBAll,tag:SQL,tag:Output/Exception
 Use SecRuleResponse "mysqladmin"                 4003302,tag:DBAll,tag:SQL,tag:Output/Exception
 Use SecRuleResponse "supplied argument is not"   4003329,tag:DBAll,tag:SQL,tag:Output/Exception
 Use SecRuleResponse "MySQL error in query"       4003332,tag:DBAll,tag:SQL,tag:Output/Exception
 Use SecRuleResponse "intitle:warning"            4003333,tag:DBAll,tag:SQL,tag:Output/Exception
 Use SecRuleResponse "SQLSTATE[[]"                4003340,tag:DBAll,tag:SQL,tag:Output/Exception
</Macro>

<Macro DBOracle>
 Use DBCommon_

 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByFullTag "DBAll|SQLStackedQuery"
 Use SecRuleArgsCookies "(?i)/(?:xsqlconfig.xml|globals.jsa|oprocmgr-status)" 4003303,tag:SQL,tag:DBAll ""
 Use SecRuleArgsCookies "(?i)/dms0\b"                                         4003304,tag:SQL,tag:DBAll,tag:SHORT ""
 Use SecRuleArgsCookies "(?i)all_(?:constraints|source|tab|views)"            4003305,tag:SQL,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies "(?i)\bexecute immediate\b"                           4003306,tag:SQL,tag:DBAll ""
 Use SecRuleArgsCookies "(?i)sys_context"                                     4003308,tag:SQL,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies "(?i)all_users"                                       4003309,tag:SQL,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies "(?i)granted_role"                                    4003310,tag:SQL,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies "(?i)user_role_privs"                                 4003311,tag:SQL,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies "(?i)all_tab_privs"                                   4003312,tag:SQL,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies "(?i)table_schema"                                    4003313,tag:SQL,tag:DBAll,tag:Underscore ""
 Use SecRuleArgsCookies "(?i)\bextproc\b"                                     4003314,tag:SQL,tag:DBAll ""
 Use SecRuleArgsCookies "(?i)\bcxtsys\b"                                      4003315,tag:SQL,tag:DBAll ""
 Use SecRuleArgsCookies "(?i)\bXDBUriType b"                                  4003352,tag:SQL,tag:DBAll ""
 Use SecRuleArgsCookies "(?i)\bsys[.](?:dba|get|user_(?:objects|tab_columns|catalog|tables|views)|tab|all_tables)" 4003350,tag:SQL,tag:DBAll,tag:Dot ""
 Use SecRuleArgsCookies "(?i)\butl_"                                          4003315,tag:SQL,tag:DBAll,tag:SHORT,tag:Underscore ""

 Use SecRuleResponse "\bORA-[0-9]{5}\b"   4003334,tag:DBAll,tag:SQL,tag:Output/Exception,tag:Dash
</Macro>

<Macro DBPostGres>
 Use DBCommon_
</Macro>

<Macro DBInformix>
 Use DBCommon_

 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByFullTag "SQLStackedQuery"
 Use SecRuleResponse "an illegal character has been found in the statement"    4003331,tag:DBAll,tag:SQL,tag:Output/Exception
</Macro>

<Macro DBSQLite>
 Use DBCommon_
</Macro>

<Macro DBNoSQL>
 Use DBCommon_

 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByTag "SQL"

 # username[$ne]=toto
 Use SecRuleDeny ARGS_NAMES "[[][$]" "phase:2,~{status}:400,id:4003343,t:none,msg:'Invalid syntax in arg name (NoSQL syntax)',tag:DBAll,tag:Dollar"
 
 # {"username": {"$ne": null}, "password": {"$ne": null}} => ARG = username.$ne
 Use SecRule REQBODY_PROCESSOR "!^(?i)json" "phase:2,t:none,id:4003344,tag:DBAll,tag:Dollar,tag:security,~{skipAfter}:AfterJSON"
  Use SecRuleDeny ARGS_NAMES "(?:^|[.])[$]" "phase:2,t:none,id:4003344,tag:DBAll,tag:Dollar,~{status}:400,msg:'Invalid syntax in arg name (NoSQL syntax)'"
 Use SecMarker AfterJSON,tag:security
</Macro>

<Macro DBMongo>
 Use DBNoSQL

 # Security rules --------------------------------------------------------------
 Use SecRuleArgsCookies "[$][a-z]{2,10}(?:[]]|\s*+:)" 4003345,tag:DBAll,tag:Dollar "msg:'Mongo DB NoSQL injection'"
 Use SecRuleArgsCookies "[.][$]"                     4003351,tag:DBAll,tag:Dollar "msg:'Mongo DB NoSQL injection'"
</Macro>

<Macro DBCouch>
 Use DBNoSQL
 # Restrict access to management API
 Use SecRuleUrl  "(?i)/_(?:active_tasks|cluster_setup|config|membership|scheduler|security|user|utils|up|uuids"       4003346,tag:DBAll,tag:AccessControl "msg:'Blocked access to management API'"
</Macro>

<Macro DBH2>
 Use DBCommon_
</Macro>

<Macro DBOther>
 Use DBCommon_
</Macro>

<Macro DBNone>
 Use DBCommon_
 Use SecRuleRemoveByTag "SQL"
</Macro>

<Macro ORM>
 Use DBNone
</Macro>
