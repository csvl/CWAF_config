# Rules for Windows
# ---------------------------------------------------------------
# Range: 2000700-2000799
# Range: 4003000-4003099

<Macro BackendOSWindows>
 # Disable warning about OS
 Use SecRuleRemoveByID 1000103
 
 # Needed in case JS redirected because of case
 Use FixMimeTypeExt "js"  "application/javascript"

 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByFullTag BackendOS
 
 # device names
 Use SecRuleUrl "(?i)\b(?:aux|nul|prn|con|(?:com|lpt)[0-9]+)[:$]" 2000703,tag:BackendOS ""
 Use SecRuleUrl "(?i)[$]mft\b"                                    2000704,tag:BackendOS,tag:Dollar ""
 
 # Windows commands
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)(?:command(?:[.]com)?|(?:cmd|forfiles)(?:[.]exe)?)(?:/.*)?/[ckr]"  2000705,tag:BackendOS,tag:Command,tag:CmdDelim,tag:Slash "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)root[.]exe"                                       4003010,tag:BackendOS,tag:Command,tag:CmdDelim,tag:Dot "msg:'Backdoor access',t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)[cw]script\b"                                     2000707,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 #Use SecRuleArgsCookies        "~{WinCmdDelim}(?i)[cw]script[.]shell"                               2000707,tag:BackendOS,tag:Dot,tag:Command,tag:CmdDelim,tag:Dot "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)(?:filesystem|create)object\b"                    2000708,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)(?:powershell|pwsh)(?:[.]exe)?(?:/|[\s;]-)[a-z]+\s" 2000709,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)(?:adodb|redim)\b"                                2000729,tag:BackendOS,tag:SHORT,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)(?:savetofile|writetext)\b"                       4003008,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)cd\s*+(?:/|[.](?:/|[.](?![.])))"                   2000702,tag:BackendOS,tag:Command,tag:CmdDelim,tag:Slash,tag:SHORT "t:~{shellDecodeWin}"
 Use SecRuleHeuristicArgsCookies "~{WinCmdDelim}(?i)cd\s*+/"                                          4003009,tag:BackendOS,tag:SHORT,tag:Command,tag:CmdDelim,tag:Slash 2 "~{shellDecodeWin}"  "Possible Command Injection Attack"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)(?:net(?:[.]exe)?\s+(?:localgroup|restart|stop)|repair\s+sam)\b"   2000732,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)(?:msinfo|runas|winmsdp?|winr[ms]|wmic|x?cacls)\b" 2000733,tag:BackendOS,tag:SHORT,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)(?:bcdboot|bootcfg|dsquery|mapisend|mbsacli|msiexec|nbtstat|net(?:dom|sh|svc|stat)|ntrights|portqry|rmtshare|rundll32|schtasks|sclist|subinacl|systeminfo|task(?:list|kill)|tsshutdn)\b"  4003000,tag:BackendOS,tag:Command "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)ps(?:exec|kill|passwd|service|shutdown|suspend)\b" 2000736,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)reg(?:ed(?:it|t32)|ini)\b"                         2000737,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)(?:regsvr(?:32)?|rundll32)\b"                      4003007,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleHeuristicArgsCookies "~{WinCmdDelim}(?i)(?:wguest|wsh)(?:[.]exe)?[/\s]"                   2000733,tag:BackendOS,tag:SHORT,tag:Command,tag:CmdDelim 2 "~{shellDecodeWin}" "Possible Command Injection Attack"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)(?:bitsadmin|taskkill|tracert)\b"                  2000742,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)msbuild(?:.exe)?[/\s+]"                            4003007,tag:BackendOS,tag:Command,tag:CmdDelim "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "~{WinCmdDelim}(?i)mshta(?:.exe)?\b"                                  4003050,tag:BackendOS,tag:Command,tag:CmdDelim,tag:SHORT "t:~{shellDecodeWin}"
 Use SecRuleArgsCookies         "(?i)microsoft[.]workflow[.]compiler\b"                               4003051,tag:BackendOS,tag:Command,tag:CmdDelim,tag:Dot "t:~{shellDecodeWin}"
 
 # Paths
 Use SecRulePathEverywhere "(?i)\b(?:boot|win)[.]ini\b" 2000710,tag:BackendOS,tag:Command,tag:Dot "t:~{shellDecodeWin}"
 
 # Absolute pathname(ex: c:\ or c:/)
 Use SecRuleArgsCookies "\b[a-zA-Z]:/"  2000711,tag:BackendOS,tag:Slash,tag:Colon,tag:PATH,tag:JSON "t:~{winPathDecode}"
 
 # System directories
 Use SecRulePathEverywhere "(?i)/(?:system32|msoffice|win(?:dows|nt)|program files|shortcut to|trace.axd)/" 2000712,tag:BackendOS,tag:Slash,tag:PATH "t:~{winPathDecode}"
 
 # MSAccess
 #Use SecRuleArgsCookies "(?i)\bmsys(?:aces|objects|queries|relationships)" 2000713,tag:BackendOS,tag:Command ""
 
 # Environment variables (smallest known is TMP - if not exist, returns %notexist%, not empty string)
 Use SecRuleArgsCookies  "(?<r2000723>[%!])~?[a-zA-Z_]{3,}(?:\k<r2000723>|:)"  2000723,tag:BackendOS,tag:Command "t:~{winPathDecode},msg:'Windows environment variable'"
 
 # Information leakage 
 Use SecRuleResponse "Volume Serial Number"                4003001,tag:BackendOS,tag:Command
 Use SecRuleResponse "Command completed"                   4003002,tag:BackendOS,tag:Command
 Use SecRuleResponse "Bad command or filename"             4003003,tag:BackendOS,tag:Command
 Use SecRuleResponse "file[(]s[)] copied"                  4003004,tag:BackendOS,tag:Command
 Use SecRuleResponse "\b(wscript[.](?:network|shell))\b"   4003006,tag:BackendOS,tag:Command
</Macro>

<Macro BackendWebIIS>
 # Disable warning about web server
 Use SecRuleRemoveByID 1000104

 Use BackendOSWindows
 Use DBSqlServer
 
 Use MixedEncoding
 
 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByFullTag BackendWeb
 
 #Use SecRuleUrl "(?i)^/scripts/"  2000719,tag:BackendWeb ""

 # IIS ---------------------------------
 Use SecRulePathEverywhere "(?i)\b(?:wwwroot|/users[.]xml|as_web|global[.]asa|fpcount|pbserver|form_(?:js|vb)cript|servervariables_jscript|trace[.]axd|iisadmin|tstisapi[.]dll|mkilog|ctss[.]idc|[.]printer|cihilitetype=full|ciwebhitsfile|cgimail|w3proxy|localstart[.]asp)\b" 2000714,tag:BackendWeb,tag:Command "t:~{winPathDecode}"
 Use SecRuleArgsCookies "(?i)\bsam[.]_" 4003046,tag:BackendWeb,tag:Command "t:~{winPathDecode}"
 Use SecRulePathEverywhere "(?i)\b(?:iisadmpwd)\b"   2000715,tag:BackendWeb,tag:Command ""
 Use SecRulePathEverywhere "(?i)^/(?:storecsvs|(?:ad|iis)?samples|sites/samples/|srchadm|inetpub|site/iis(?:admin|protect)|_mem_bin|pcadmin)/"  2000716,tag:BackendWeb ""
 Use SecRuleArgsCookies "(?i)/search97[.]vts|/(?:(?:view|show)code|uploadscript11|directorylisting|ping)[.]asp"  2000717,tag:BackendWeb,tag:Command,tag:Slash,tag:Dot "t:~{winPathDecode}"
 # IIS JET VBA access
 Use SecRuleUrl "(?i)/advworks/equipment/catalog_type[.]asp"  2000718,tag:BackendWeb ""
 
 # Generic IIS backdoor
 Use SecRuleArgsCookies "(?i)server[.]createobject"  2000730,tag:BackendOS,tag:Command "t:~{jsDecode}"
 #Use SecRuleArgsCookies       "(?i)server[.]createobject.*shell[.]application"  2000723,tag:BackendOS,tag:Dot,tag:Command "t:~{jsDecode}"
 
 # WEB-IIS SQLXML content type overflow
 #Use SecRuleArgsCookies "(?i)\bcontenttype\s*+=" 2000721,tag:BackendWeb,tag:Equal "t:~{encodedParam}"
 
 # FrontPage
 #Use SecRuleArgsCookies "/(?i:_private|_vti_(?:aut|cnf|pvt)|admcgi|authors.pwd|admisapi|(?:cfgwiz|fp(?:admcgi|count|remadm.|srvadm)|scripts/tools/getdrvs)[.]exe|msadc/samples/adctest.asp)" 2000726,tag:BackendWeb,tag:Command,tag:Slash "t:~{winPathDecode}"
 
 # Windows Work Folders
 #Use SecRuleUseragent "(?i)WorkFoldersClient"  2000701,tag:BackendWeb,tag:Command ""
 
 # Site Server
 #Use SecRuleUrl "(?i)/Admin/knowledge/persmbr/"  2000734,tag:BackendWeb ""

 # IIS leakage
 Use SecRuleResponse "ADODB[.]Command" 4003020,tag:BackendWeb,tag:SQL,tag:Command
 Use SecRuleResponse "error \x27800" 4003026,tag:BackendWeb,tag:Command

 Use SecRuleResponse "\bserver error in.{0,50}\bapplication\b"       4003030,tag:BackendWeb,tag:Command,tag:Output/Exception
 Use SecRuleResponse "[[]To Parent Directory[]]"                     4003034,tag:BackendWeb,tag:Command
 Use SecRuleResponse "Directory Listing Denied"                      4003035,tag:BackendWeb,tag:Command
 Use SecRuleResponse "<legend>Detailed Error Information</legend>"   4003036,tag:BackendWeb,tag:Command
 Use SecRuleResponse "\binetpub\b"                                   4003037,tag:BackendWeb,tag:Command,tag:Output/Exception

 # SQL errors
 Use SecRuleResponse "Microsoft OLE DB Provider"  4003038,tag:BackendWeb,tag:SQL,tag:Command
 Use SecRuleResponse "ODBC Drivers"               4003039,tag:BackendWeb,tag:SQL,tag:Command
 Use SecRuleResponse "[(]Using password:"         4003043,tag:BackendWeb,tag:SQL,tag:Command
 Use SecRuleResponse "Undefined index:"           4003044,tag:BackendWeb,tag:SQL,tag:Command
 Use SecRuleResponse "[[](?i:CLI driver|ODBC|Informix|Oracle|Microsoft)"   4003045,tag:BackendWeb,tag:SQL,tag:Command

 # SQL and other containers errors
 Use SecRuleResponse "incorrect syntax near"    4003005,tag:BackendWeb,tag:SQL,tag:Command
</Macro>

# Obsolete
<Macro IISBackend>
 Use BackendWebIIS
</Macro>

<Macro IIS6Backend>
 Use BackendWebIIS
 Use BackConnectionHttp1.0
</Macro>

<Macro BackendWebOWin>
 # Disable warning about web server
 Use SecRuleRemoveByID 1000104

 Use BackendOSWindows
</Macro>

# ISA server
<Macro ISABackend>
 Use SecRuleResponse "\b(403 forbidden\b.{1,200}\binternet security and acceleration server)\b" 4003090,tag:BackendWeb,tag:Command
</Macro>
