# Rules for Java framework
# ---------------------------------------------------------------
# Range: 4003700-4003899

# Allow ; and = in URL only for jsessionid
<Macro SecURLJSessionIdSyntax>
 Use SecAction "phase:2,~{nosecaction},tag:FrameworkTop,setvar:TX.JSessionIdAllowed"
</Macro>

<Macro FrameworkJava>
 Use SkipFramework_ Java
 Use SetSession "JSESSIONID(?:[.][0-9a-f]+)?"
 
 # Can be higher on some App Servers (Websphere, Weblogic)?
 #Use CheckCookieLength /jsessionid/  27|32

 # Disable warning about development framework
 Use SecRuleRemoveByID 1000105

 # Security rules --------------------------------------------------------------
 Use SecRuleRemoveByFullTag FrameworkTop
 
 Use SecURLJSessionIdSyntax

 Use SecRuleArgsCookies "[+]\s*+#\s*+(?:application|session|root)\s*+[+]" 4003711,tag:FrameworkTop,tag:HashTag "msg:'OGNL exploit'"
 Use SecRuleArgsCookies "#\s*+_memberaccess|_memberaccess\s*+[[]" 4003713,tag:FrameworkTop,tag:Underscore "msg:'OGNL exploit'"
 Use SecRuleArgsCookies "ognl(?:context|util)"            4003714,tag:FrameworkTop,tag:PossibleName,tag:Command "t:none,msg:'OGNL exploit'"
 # ${ already blocked by '2000455'
 # #{ already blocked by '2000456'
 Use SecRuleArgsCookies "\b_self\b"                       4003719,tag:FrameworkTop,tag:Underscore,tag:SHORT "msg:'Various Java Templating keyword'"
 Use SecRuleArgsCookies "root[.]process"                  4003720,tag:FrameworkTop,tag:Dot "msg:'Various Java Templating keyword'"
 Use SecRuleArgsCookies "[[<]#"                           4003722,tag:FrameworkTop,tag:HashTag "msg:'FreeMarker Templating tag'"
 Use SecRuleArgsCookies "freemarker[.]template"           4003723,tag:FrameworkTop,tag:Dot "msg:'FreeMarker Templating namespace'"
 Use SecRuleArgsCookies "com[.]sun[.]|java[.](?:[*]|beans|io|lang|net|rmi|util)\|javax[.]|org[.](?:apache|codehaus|springframework)"    4003728,tag:FrameworkTop,tag:Dot "msg:'Java namespace'"
 Use SecRuleArgsCookies "\bjava[.][a-z]+[.]"              4003717,tag:FrameworkTop,tag:Dot "msg:'Java namespace'"
 Use SecRuleArgsCookies "get(?:class|runtime|method)"     4003730,tag:FrameworkTop,tag:XSS ""

 # Remote Protocol Inclusion: ...://
 Use SecRuleArgsCookies "\b(?i:jar|jdbc)://" 4003727,tag:specific,tag:Parano,tag:Colon,tag:Slash "msg:'Specific internal path/protocol'"

 # https://issues.apache.org/jira/browse/WW-3631
 Use SecRuleDeny ARGS_NAMES  "(?i)^session[.]"   "phase:2,t:none,~{status}:500,id:4003715,tag:FrameworkTop,msg:'Struts session tampering exploit'"
 
 # Spring Expression Language 
 Use SecRuleDeny ARGS_NAMES|REQUEST_HEADERS_NAMES "(?i)^class[.](?:module[.])?classLoader[.]" "phase:2,t:none,~{status}:500,id:4003731,tag:FrameworkTop,msg:'Spring Expression Language exploit'"
 Use SecRuleDeny ARGS_NAMES|REQUEST_HEADERS_NAMES "(?i)^spring[.]"                            "phase:2,t:none,~{status}:500,id:4003732,tag:FrameworkTop,msg:'Spring Expression Language exploit'"
 
 # Generic Java proxy
 Use SecRuleArgsCookies "allowstaticmethodaccess|nativestring" 4003716,tag:FrameworkTop ""
 Use SecRuleArgsCookies "\b(?:buffered|file)writer\b"          4003718,tag:FrameworkTop,tag:PossibleName "msg:'Java keyword'"

 # Base64 & hexa-encoded Java serialized object
 Use SecRuleArgsCookies  "^(?:aced00|ae8d00|ro0)"              4003729,tag:FrameworkTop,tag:EXPLOIT "msg:'Java serialized object'"

 Use SecRuleArgsCookies "\bstruts2\b"                          4003742,tag:FrameworkTop,~{testRule},rev:20240306    "~{caseSensitive}"
 Use SecRuleArgsCookies "ServletActionContext"                 4003742,tag:FrameworkTop,~{testRule},rev:20240306    "~{caseSensitive}"
 
 # Information leakage 
 Use SecRuleResponse "Thread[.]java"             4003701,tag:FrameworkTop,tag:Develop
 Use SecRuleResponse "Servlet Exception"         4003702,tag:FrameworkTop,tag:Develop
 Use SecRuleResponse "ObjectNotFoundException"   4003703,tag:FrameworkTop,tag:Develop
 Use SecRuleResponse "Exception: java[.]net[.]"  4003704,tag:FrameworkTop,tag:Develop
 Use SecRuleResponse "an exception has occured"  4003705,tag:FrameworkTop,tag:Develop
 # Some have a link to something like /acegisecurity: Use SecRuleResponse "acegisecurity"             4003706,tag:FrameworkTop,tag:Develop
 Use SecRuleResponse "java[.](?:io|lang)"        4003707,tag:FrameworkTop,tag:Develop
 Use SecRuleResponse "import[.]java"             4003708,tag:FrameworkTop,tag:Develop
 Use SecRuleResponse "HttpFileServer"            4003709,tag:FrameworkTop,tag:Develop
 Use SecRuleResponse "Request[.]QueryString|QueryAdaptor|query[.]hibernate"  4003710,tag:FrameworkTop,tag:Develop
 Use SecRuleResponse "javax[.]servlet|<jsp:"     4003724,tag:FrameworkTop,tag:Develop

 # Java serialized object (binary characters already blocked)
 ###Use SecRuleArgsCookies "\xac\xed\x00\x05"  .....  "msg:'Java serialized object',~{status}:400,tag:FrameworkTop,tag:EXPLOIT"

 Use SecMarker AfterFrameworkJava
</Macro>

# Rules for JSP framework
<Macro FrameworkJSP>
 Use FrameworkJava
 #Use SecAllowExt jsp 
 # Allow some specials characters in URL
 Use SecUrlAllowChars " ()#\[\]{};="
 Use SecAllowMultipleExtInUrl
 # Allow .. in URL !!!
 Use SecRuleRemoveByID 2000102
 # Allow ARGS names longer than 100 !!!
 Use SecArgNameSizeMax 1000
 # Allow :: etc
 Use SecRuleRemoveByID 2000815

 Use SecRuleArgsCookies "(?i)<\s*+(?i:c|jsp|sql):" 4003739,tag:FrameworkTop,tag:LowerThan  "msg:'Server tag'"

 # Known exploit: Web shells
 Use SecRuleArgsCookies "\b(?:jbossass|shellinvoker|mela|(?:ze)?cmd|wstats|dssvc|iesvc)[.]jsp\b"  4003726,tag:EXPLOIT,tag:Dot "~{status404},msg:'Web shell'"
</Macro>

# For JSpellTools
<LocationMatch "/jspell[.]jsp$">
 Use SecRuleRemoveByID 2000329
</LocationMatch>

# Rules for JSF framework
<Macro FrameworkJSF>
 Use FrameworkJava
</Macro>

# Rules for RichFaces
<Macro FrameworkRichFaces>
 # Will be stored after most rules execution
 #Use SecRule ARGS:do  "@unconditionalMatch" "phase:2,~{nosecaction},t:none,t:base64Decode,setvar:'tx.SpecificArg=%{MATCHED_VAR}'"

 Use FrameworkJSF
 Use SecAllowDotInUrl
</Macro>

# Rules for Stapler framework
<Macro FrameworkStapler>
 Use FrameworkJSP
 Use FrameworkSpring
 Use SecAllowContentType "application/x-stapler-method-invocation"
</Macro>

# Rules for Tapestry framework
<Macro FrameworkTapestry>
 Use FrameworkJava
 Use SecAllowMultipleExtInUrl
 # Allow strange characters in URL
 Use SecUrlAllowChars ",;=\$"

 Use SecAllowExt "thtml|svc|s?direct"
</Macro>

# Rules for Spring framework
<Macro FrameworkSpring>
 Use SkipFramework_ Spring
 Use FrameworkJava
 # Remember me in a cookie: base64(user:token)
 Use SecRestrictCookieAuth ACEGI_SECURITY_HASHED_REMEMBER_ME_COOKIE "^(?:~{UserNameSyntax})$" ~{UserNameLengthMax} 200
 # Remember me in a cookie, but userid not inside
 Use AcceptCookie SPRING_SECURITY_REMEMBER_ME_COOKIE
 
 Use SecMarker AfterFrameworkSpring
</Macro>

# Rules for SpringBoot framework
<Macro FrameworkSpringBoot>
 Use SkipFramework_ SpringBoot
 Use BackendWebJava
 Use SecRuleUrl      "^/actuator/"                                   4003712,tag:FrameworkTop,tag:AccessControl "msg:'Management path'"
 Use SecRuleResponse "This application has no explicit mapping for"  4003722,tag:FrameworkTop,tag:Develop
 Use SecRuleResponse "could not be parsed at index"                  4003725,tag:FrameworkTop,tag:Develop
 
 Use SecMarker AfterFrameworkSpringBoot
</Macro>

# Rules for Wicket framework
<Macro FrameworkWicket>
 Use FrameworkJava
 Use SecAllowQueryInPost
 Use SecArgNameAllowCharacter ":"
</Macro>

<Macro FrameworkVelocity>
 Use FrameworkJava

 # $... syntax 
 Use SkipAfterOnSuccess  4003113,tag:security,tag:Dollar,tag:XQuery AfterVelocityDollar
  Use SecRuleArgsCookies "[$][a-z_]"                       4003738,tag:FrameworkTop,tag:Dollar,tag:XQuery "msg:'Velocity Templating keyword'"
  Use SkipAfterOnSuccess 4003738,tag:security,tag:Dollar,tag:XQuery AfterVelocityDollar
  Use SecRuleArgsCookies "[$](?:class|i18n)"               4003721,tag:FrameworkTop,tag:Dollar            "msg:'Velocity Templating keyword'"
 Use SecMarker AfterVelocityDollar,tag:security,tag:XQuery
 # Templating tags
 Use SecRuleArgsCookies "[{]velocity"                     4003740,tag:FrameworkTop,tag:CurlyBrace  "msg:'Templating tag'"

 Use SecRuleArgsCookies "\bKEY_velocity"                  4003741,tag:FrameworkTop,tag:Underscore  "msg:'Velocity Templating keyword'"

 Use SecAllowExt "v(?:m|sl)" 
</Macro>

# SnakeYAML / ScriptEngine:
# !!
# ScriptEngineManager

# YamlBeans
# !com. !org. !java

