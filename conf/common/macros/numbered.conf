# ModSecurity rules containing an hard-coded rule id
# --------------------------------------------------
# Range: 2000900-2000999

# For Safari "preview" feature
# ------------------------------------------------------------------------------
DefineStr SafariPreviewId 2000901

# Set home page (cf. Safari "preview" feature)
<Macro SetHomePageExt_ $host $url $full_url>
 Use SecRuleRemoveByID ~{SafariPreviewId}
 Use SecRule REQUEST_HEADERS:Host  "@streq $host" "phase:1,id:~{SafariPreviewId},t:none,~{nosecaction},setvar:TX.homePage=$full_url"
 Use SecRule REQUEST_HEADERS:Host  "@streq $host" "phase:2,id:~{SafariPreviewId},t:none,chain,~{skip}:1"
  Use SecRule TX:url "@streq $url" "t:none"
 Use SecRule REQUEST_HEADERS:X-Purpose "^review$"  "phase:2,id:~{SafariPreviewId},t:none,~{nosecaction},redirect:'$full_url'"
</Macro>
<Macro SetHomePageExt $http $host $url>
 Use SetHomePageExt_  $host $url "$http://$host/$url"
</Macro>

<Macro SetHomePage @url>
 Use SetHomePageExt_  "%{REQUEST_HEADERS.Host}" @url @url
</Macro>

<Macro DontLogStatus $status>
 Use SecAction "phase:2,id:2000902,~{nosecaction},tag:logging,tag:Status,tag:security,setvar:'tx.NoLogStatus=%{tx.NoLogStatus}|$status'"
</Macro>
<Macro LogUntrappedStatuses>
 # These status have a specific rule => don't trigger generic rule when disabled
 Use SecAction "phase:2,id:2000902,~{nosecaction},tag:logging,tag:Status,tag:security,setvar:'tx.NoLogStatus=[123]|40[013458]|50[0234]'"
 Use SecRule RESPONSE_STATUS "!^(?:%{tx.NoLogStatus})"  "phase:3,id:2000902,t:none,tag:logging,tag:Status,~{increaseBlockCounter},~{warn},msg:'Untrapped status from back-end: %{MATCHED_VAR}'"
</Macro>
<Macro LogUntrappedErrors @except>
 Use DontLogStatus        @except
  Warning LogUntrappedErrors is obsolete, use DontLogStatus (with a regex)
</Macro>
<Macro DontLogStatuses>
 Use SecRuleRemoveByID 2000902
</Macro>

# Allow auto-detection of some request types when Content-Type header is missing or invalid
<Macro ReqContentAutodetect>
 Use SecStreamInBodyInspection On
 # No more needed from RH 8.6
 <IfVersion < 2.4.48>
  Use NotInsideLocation
  Use SecRuleDeny REQUEST_HEADERS:Transfer-Encoding "chunked" "phase:1,t:none,tag:autodetect,id:2000903,tag:specific,~{status}:400,msg:'Chunked encoding is not supported with content auto-detection.'"
 </IfVersion>
 Use SecRule STREAM_INPUT_BODY "^(?:PK\x03\x04|\x03\x04PK|%PDF-)"         "phase:2,t:none,tag:autodetect,~{skipAfter}:EndOfReqContentAutodetect,setvar:TX.ReqCompressed,setvar:'TX.additionalInfo=(compressed content or PDF not logged)'"
 Use SecRule REQUEST_HEADERS:Content-Type "csp-report|reports+json"       "phase:2,t:none,tag:autodetect,~{skipAfter}:EndOfReqContentAutodetect"
  Use SecRule ENV:req_svg @unconditionalMatch                             "phase:2,t:none,tag:autodetect,~{skip}:1"
  Use SecRule STREAM_INPUT_BODY "^\s*+(<[?]xml\s+[^>]*+>.{0,200}<DOCTYPE\s+svg)" "phase:2,t:none,tag:autodetect,~{skipAfter}:EndOfReqContentAutodetect,capture,setenv:req_xml,setvar:TX.req_svg=%{TX.1},setvar:'TX.additionalInfo=(SVG content)'"
  Use SecRule ENV:req_xml @unconditionalMatch                             "phase:2,t:none,tag:autodetect,~{skip}:1"
  Use SecRule STREAM_INPUT_BODY "^\s*+(<[?]xml\s.{0,50})"                  "phase:2,t:none,tag:autodetect,~{skipAfter}:EndOfReqContentAutodetect,capture,setenv:req_xml,setvar:TX.xml_detected=%{TX.1},setvar:'TX.additionalInfo=(XML content)'"
  Use SecRule ENV:req_json @unconditionalMatch                            "phase:2,t:none,tag:autodetect,~{skip}:1"
  Use SecRule STREAM_INPUT_BODY "^\s*+([[]?\s*+[{]\s*+\x22.{0,20})"          "phase:2,t:none,tag:autodetect,~{skipAfter}:EndOfReqContentAutodetect,capture,setenv:req_json,setvar:TX.json_detected=%{TX.1},setvar:'TX.additionalInfo=(JSON content)'"
 Use SecMarker EndOfReqContentAutodetect,tag:autodetect
</Macro>
# No more needed from RH 8.6
<Macro AllowStreamInBodyInspectionChunked>
 # Allow chunked-encoding
 Use SecRuleRemoveById 2000903
</Macro>
# If used inside location, will not allow chunked-encoding
<Macro NoReqContentAutodetect>
 Use SecStreamInBodyInspection Off
 Use SecRuleRemoveByFullTag autodetect
 Use AllowStreamInBodyInspectionChunked
</Macro>

# Exceptions for auto-detect based on Content-Type
# Rules id are the same as in final.conf
<Macro NoJSONAutodetect @ct>
 Use SecRule REQUEST_HEADERS:Content-Type @ct "phase:2,id:2002401,~{nosecaction},ctl:ruleRemoveById=2002401"
</Macro>
<Macro NoXMLAutodetect @ct>
 Use SecRule REQUEST_HEADERS:Content-Type @ct "phase:2,id:2002402,~{nosecaction},ctl:ruleRemoveById=2002402"
</Macro>
