# Macros and rules defined to test the WAF in front of the Juniper "Dana" rewriting

# $path may be a regex and must contain beginning & ending /
<Macro JuniperDanaRewrite>
 # To solve problems with Juniper devices
 Setenv proxy-nokeepalive
 RequestHeader unset Expect early
 Use DisableUserTracking
 Use DeleteResponseCookie "_acl"

 # Do not check server certificate
 Use NoBackendCertifCheck
 
 # Internal Juniper pages
 Use SecRuleEngineUrl  Off  "^/dana-"
 <LocationMatch ^/dana>
  Use PackageSoftware
  Use SecRuleEngine off
  Header unset ~{CspHeader}
 </LocationMatch>

 #RewriteCond %{REQUEST_URI} "!^/dana"
 # RewriteRule "^(.*),DanaInfo=[^+]+[+](.*)$" "$1$2"           [L,noescape,nosubreq,redirect,DPI]
  #RewriteRule "^(.*)/([^/]*)$" "$1,DanaInfo=%{HTTP_HOST}+$2"  [noescape,nosubreq,PT,DPI]

 Use SecUrlAllowChars ",= $"
 
 Header edit Location ",DanaInfo=[^+]+[+]" ""
 #Use Substitute "s`,DanaInfo=[^+]{1,200}[+]``q"
</Macro>

# Block old URL generated by Juniper
<IfDefine !noSecurityRules>
 Use SecRule TX:url ",DanaInfo="  "phase:1,t:none,tag:specific,~{stop404},msg:'Old URL generated by Juniper',tag:URL"
</IfDefine>

