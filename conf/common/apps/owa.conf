# Macros and rules defined for Outlook Web Access 2007
# ---------------------------------------------------------------
# Range: 6000100-6000199

<Macro OWA2007_Proxy_ $(ssl) @frontServer $frontPath @protocol $backServer $backPort @backPath>

 RewriteRule ^$frontPath/?$    $frontPath/exchange/  [L,R=permanent,NE,DPI]
 Use Proxy$(ssl)Ext @frontServer "$frontPath" @protocol "$backServer" $backPort @backPath
 Use SecWebAppId OWA2007
 Use UTF8Encoding "^$frontPath/"

 <Location $frontPath/>
  Use PackageSoftware
  Header unset "X-OWA-DiagnosticsInfo"
  #Header unset "X-OWA-MinimumSupportedOWSVersion"
  Header unset "X-OWA-Version"
  #Header unset "X-OWA-OWSVersion"
  Header unset "X-OWA-Version"

  Use MixedEncoding
 
  Use SetSession   sessionid
  Use AcceptCookie bcsi-owa
 
  # Some URL to block: /ecp
  Use SecRuleUrl "!^$frontPath/(?i:exchange|exchweb|eas-web|public)(?:/|$)" 6000102,tag:AccessControl "status:404,msg:'OWA path'"

  # sessionid=1fd1d869-27b1-42fd-9a8f-0f2f816727a1:0x809
  #           e0bc49e1-ec6e-444a-823a-c94e52c82234:0x140c
  Use SecRule REQUEST_COOKIES:sessionid  "!^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}:0x[0-9a-f]{1,4}$"  "phase:2,t:none,~{increaseBlockCounterMax},~{deny},tag:EXPLOIT,msg:'Invalid session id'"
 
  # Limits (see http://support.microsoft.com/default.aspx?scid=kb;en-us;823175)
  #Use SecRequestLineSizeMax    16384

  Use SecNoCheckResponse
 </Location>


 <Location $frontPath/iisadmpwd>
  # Allow "iisadmpwd"
  Use SecRuleRemoveByID 2000715
 
  # Only needed for Windows 2000?
  #Use SecAllowExt "htr"
 
  Use SecPassword old
  Use SecPassword /new2?/
 </Location>


 <LocationMatch ^$frontPath/(?i:exchange|public)/>
  # Manage URL
  Use SecUrlAllowAllChars
  Use SecAllowTechnicalArgs
  Use SecAllowTechnicalInURL
  Use SecAllowAllExt
  Use SecAllowMultipleExtInUrl

  # Allow .., etc. in some URL
  Use SecRuleRemoveByID 2000102-2000005
  Use SecRuleUrl  "[.][.]/"  2000102,tag:EXPLOIT "msg:'OWA path'"

  # Allow spaces in URL
  #Use SecRuleRemoveByID ?
 
  # Allow all characters in header "Location" & Destination
  Use SecRuleRemoveByID 2002928-2002929
  
  # Allow Content-Language, etc.
  Use SecRuleRemoveByID 2002913
 
  # OWA specific method
  Use SecRule REQUEST_METHOD "^X-MS-ENUMATTS$"  "phase:2,~{nosecaction},t:none,setvar:TX.allowed_method=1"

  #Use SecAllowExt "asa|cdx|cer|crt"
 
  # Manage contents
  Use AllowWebDAV
  Use SecAllowQueryInPost
  Use SecAllowTechnicalArgs
  Use SecAllowAllUpFileExt
    # restrict path?
    # accept only the expected HTML syntax?
    # warning: opens all args
    #Note: To allow URL encoding in Contact record page.
    #Use SecAllowHTMLArg "urn:schemas:contacts:businesshomepage"
</LocationMatch>

 <LocationMatch ^$frontPath/(?i:exchweb)/>
  Use SecAllowMultipleExtInUrl
  Use SecAllowExt "xsl"
  Use SecAllowTechnicalArgs
 </LocationMatch>

 <LocationMatch ^$frontPath/(?i:exchweb/bin)/>
  Use SecAllowExt "asp"
 </LocationMatch>

 # Spell checker
 <LocationMatch ^$frontPath/(?i:exchweb/bin/spell/owaspell.dll)$>
  Use SecAllowExt "dll"
  # Correct chunked encoding sent by IIS
  AddOutputFilterByType substitute text/xml
  Use Substitute "s/^[a-f0-9]{1,500}//i"
 </LocationMatch>

 # Spell checker
 <LocationMatch ^$frontPath/(?i:exchweb/owaauth.dll)$>
  Use SecAllowExt "dll"
 </LocationMatch>

 # S/MIME control (download & local install)
 <LocationMatch ^$frontPath(?i:/exchweb/.*/cabs/setupmcl.exe)$>
  Use SecAllowExt "exe"
 </LocationMatch>
 # Block the download of the S/MIME control, but don't count it as an attack
 #Use SecRule TX:url  "/exchweb/.*/cabs/setupmcl.exe"  "phase:1,~{stopStatus}:403,tag:URL"

 # Exploits (OWA 2003 & 2007 before SP3)
 Use SecRule TX:url  "!(?i)/root[.]asp"     "phase:2,id:6000101,tag:security,tag:URL,~{skipAfter}:AfterRootASP"
  Use SecRule ARGS:acs "^anon$"        "phase:2,id:6000101,tag:URL,t:~{winPathDecode},~{status404},~{increaseBlockCounterMax},msg:'Blocked path'"
 Use SecMarker AfterRootASP,tag:security
 Use SecRule TX:url  "!(?i)/logonfrm[.]asp" "phase:2,id:6000103,tag:security,tag:URL,~{skipAfter}:AfterLogonFrm"
  Use SecRule ARGS "%%%"                    "phase:2,id:6000103,tag:URL,tag:Percent,t:none,~{status404},~{increaseBlockCounterMax},msg:'Blocked path'"
 Use SecMarker AfterLogonFrm,tag:security
 Use SecRuleArgs  "name\s*+=\s*+.?forwardtotype"  6000104,~{caseSensitive},tag:Equal,tag:EXPLOIT ""
 Use SecRuleArgs  "rt\s*+=\s*+.?smtp"             6000105,~{caseSensitive},tag:Equal,tag:EXPLOIT ""
 Use SecRuleUrl   "(?i)/ev[.]owa"               6000106,tag:AccessControl "msg:'OWA path'"
</Macro>

<Macro OWA2010_Proxy_ $(ssl) @frontServer $frontPath @protocol $backServer $backPort @backPath>

 RewriteRule ^$frontPath/?$    $frontPath/owa/  [L,R=permanent,NE,DPI]
 Use Proxy$(ssl)Ext @frontServer "$frontPath" @protocol "$backServer" $backPort @backPath
 Use SecWebAppId OWA2010
 Use UTF8Encoding "^$frontPath/"

 <Location $frontPath/>
  Header unset "X-OWA-DiagnosticsInfo"
  #Header unset "X-OWA-MinimumSupportedOWSVersion"
  Header unset "X-OWA-Version"
  #Header unset "X-OWA-OWSVersion"
  Header unset "X-OWA-Version"

  Use MixedEncoding
 
  #Use SetSession sessionid
  #Use AcceptCookie bcsi-owa
 
  Use SecRuleUrl "!^$frontPath/(?i:owa)(?:/|$)" 6000107,tag:AccessControl "status:404,msg:'OWA path'"

  # sessionid=1fd1d869-27b1-42fd-9a8f-0f2f816727a1:0x809
  #           e0bc49e1-ec6e-444a-823a-c94e52c82234:0x140c
  #?Use SecRule REQUEST_COOKIES:sessionid  "!^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}:0x[0-9a-f]{1,4}$"  "phase:2,~{increaseBlockCounterMax},~{deny},t:none,msg:'Invalid session id',tag:specific"
 
  Use SecNoCheckResponse
 </Location>

<IfDefine xxxxxxxx>
 <Location $frontPath/iisadmpwd>
  # Allow "iisadmpwd"
  Use SecRuleRemoveByID 2000715
 
  Use SecPassword old
  Use SecPassword new
  Use SecPassword new2
 </Location>
</IfDefine>

 <LocationMatch ^$frontPath/(?i:owa)/>
  # Manage URL
  Use SecUrlAllowAllChars
  Use SecAllowTechnicalArgs
  Use SecAllowTechnicalInURL
  Use SecAllowAllExt
  Use SecAllowMultipleExtInUrl

  # Allow .., etc. in URL
  Use SecRuleRemoveByID 2000102-2000005
  Use SecRuleUrl  "[.][.]/"  2000102,tag:EXPLOIT "msg:'OWA path'"

  # Allow spaces in URL
  #Use SecRuleRemoveByID ?
 
  # Allow all characters in header "Location" & Destination
  Use SecRuleRemoveByID 2002928-2002929
  
  # Allow Content-Language, etc.
  Use SecRuleRemoveByID 2002913
 
  # OWA specific method
  Use SecRule REQUEST_METHOD "^X-MS-ENUMATTS$"  "phase:2,~{nosecaction},t:none,setvar:TX.allowed_method=1"

  #Use SecAllowExt "asa|cdx|cer|crt"
 
  # Manage contents
  Use AllowWebDAV
  Use SecAllowQueryInPost
  Use SecAllowTechnicalArgs
  Use SecAllowAllUpFileExt
    # restrict path?
    # accept only the expected HTML syntax?
    # warning: opens all args
    #Note: To allow URL encoding in Contact record page.
    #Use SecAllowHTMLArg "urn:schemas:contacts:businesshomepage"
</LocationMatch>

</Macro>

<Macro OWA2013_Proxy_ $(ssl) @frontServer $frontPath @protocol $backServer $backPort @backPath>

 RewriteRule ^$frontPath/?$    $frontPath/owa/  [L,R=permanent,NE,DPI]
 Use Proxy$(ssl)Ext @frontServer "$frontPath" @protocol "$backServer" $backPort @backPath
 Use SecWebAppId OWA2013
 Use UTF8Encoding "^$frontPath/"

 # Allow Outlook autodiscovery
 Use SecRuleRemoveByFullTag Exchange
 Use SecRule TX:url "^(?i)$frontPath/autodiscover/(?:autodiscover[.](?:svc|xml)|Services[.]wsdl)$" "~{Oidc401Action}=OWA-discovery"
 <LocationMatch  ^(?i)$frontPath/autodiscover/(?:autodiscover[.](?:json|svc|xml)|Services[.]wsdl)$>
  AuthType none
  Require all granted
  Use SecAction "phase:2,~{stopSecurity}"
 </LocationMatch>

 # Replace name of back-end server by real one
 Use RemapUrlInHeaders
 #Use FixResponseHeadersHost https @frontServer 443 "$frontPath" "$backServer"

 <Location $frontPath/>
  Header unset "X-OWA-DiagnosticsInfo"
  #Header unset "X-OWA-MinimumSupportedOWSVersion"
  Header unset "X-OWA-Version"
  #Header unset "X-OWA-OWSVersion"
  Header unset "X-OWA-Version"

  Use AcceptAllCookies
  #Use SetSession sessionid
  #Use AcceptCookie bcsi-owa
 
  Use SecRuleUrl "!^$frontPath/(?i:owa)(?:/|$)" 6000107,tag:AccessControl "status:404,msg:'OWA path'"
  Use SecNoCheckResponse

  # Manage URL
  #Use SecUrlAllowAllChars
  #Use SecAllowTechnicalInURL
  Use SecAllowExt "owa"
  #Use SecAllowExt "ashx|owa2?|svc"
  Use SecAllowMultipleExtInUrl

  # Allow .., etc. in URL
  #Use SecRuleRemoveByID 2000102-2000005
  #Use SecRuleUrl  "[.][.]/"  2000102 "msg:'OWA path',tag:URL"

  # Allow spaces in URL
  #Use SecRuleRemoveByID 2000006
 
  # Allow all characters in header "Location" & Destination
  #Use SecRuleRemoveByID 2002928-2002929
  
  # Allow Content-Language, etc.
  #Use SecRuleRemoveByID 2002913
 
  # OWA specific method
  #Use SecRule REQUEST_METHOD "^X-MS-ENUMATTS$"  "phase:2,~{nosecaction},t:none,setvar:TX.allowed_method=1"

  #Use SecAllowExt "asa|cdx|cer|crt"
 
  # Manage contents
  #Use AllowWebDAV
  #Use SecAllowQueryInPost
  Use SecAllowTechnicalArgs
  Use SecAllowAllUpFileExt
    # restrict path?
    # accept only the expected HTML syntax?
    # warning: opens all args
    #Note: To allow URL encoding in Contact record page.
    #Use SecAllowHTMLArg "urn:schemas:contacts:businesshomepage"
 </LocationMatch>
</Macro>

# OWA 2016+
# Use SecBadAuthRedirect "/owa/auth/logon[.]aspx[?].*&reason="

<Macro OWA2007_Proxy @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use OWA2007_Proxy_ "" @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro OWA2007_ProxySSL @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use OWA2007_Proxy_ SSL @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro OWA2010_Proxy @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use OWA2010_Proxy_ "" @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro OWA2010_ProxySSL @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use OWA2010_Proxy_ SSL @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro OWA2013_Proxy @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use OWA2013_Proxy_ "" @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>

<Macro OWA2013_ProxySSL @frontServer @frontPath @protocol @backServer @backPort @backPath>
 Use OWA2013_Proxy_ SSL @frontServer @frontPath @protocol @backServer @backPort @backPath
</Macro>
