<Macro OTRS_ProxySSL @frontServer $frontPath @protocol $backServer $backPort $backPath>

 Use UTF8Encoding "^$frontPath/"

 # Main page
 RewriteRule "^$frontPath/?$" "$frontPath/customer.pl" [R,L,DPI]
 
 # For static resources JS, CSS, ...
 #Use ProxySSLExt  @frontServer "$frontPath/res_" @protocol $backServer $backPort "$backPath/../otrs-web"

 # For the application itself
 Use ProxySSLExt  @frontServer "$frontPath" @protocol $backServer $backPort "$backPath"
 Use SecWebAppId OTRS

 <Location "$frontPath/">
  Use PackageSoftware
  Use FrameworkPerl
  Use DBPostGres

  Use RemapUrl
  Use CSPallowEvalInScript
  Use CSPallowInternalScript
  Use CSPallowInternalStyle

  Use SecArgsAllowUnicode
  Use AcceptCookieRegex "OTRS[~{CharMin}]{0,20}"
 
  Use SecAllowDotInUrl

  # Due to the use of ";" as argument separator in OTRS queries
  Use SecRuleRemoveByID 2000001,2000002,2000021,2000822,2000815,2000849,2000869,2000891,2000893,2000894
  Use SecArgNameAllowCharacter ";"
  Use SecArgNameAllowEmpty

  Use SecAllowURL
  Use SecAllowPath
  Use SecAllowHTMLArg body
  
  # Limit Admin interface to internal addresses only
  Use SecRule QUERY_STRING  "!(?i)Action=Admin" "phase:2,t:none,tag:security,~{skipAfter}:AfterAdmin"
   Use SecRuleIp "!@ipMatch ~{IpInternal_}"  "phase:2,t:none,~{deny},~{increaseBlockCounter},msg:'Admin interface restricted to internal addresses'"
  Use SecMarker AfterAdmin,tag:security
 </Location>

 # Agents page
 <LocationMatch "^$frontPath/index.pl">
  Use SecAllowExt "pl"
  Use SecArgNameAllowCharacter "][:#;"
 </LocationMatch>

 # Admin page
 <LocationMatch "^$frontPath/index.pl">
  Use SecAllowTechnicalArgs
  # Config contains URL ending with =, like "http://maps.google.com/maps?z=7&q="
  Use SecRuleRemoveByID 2000894
  # Config contains "sendmail"
  Use SecRuleRemoveByID 4003126
  Use SecAllowBase64
  # Upload/Download of config files
  Use SecAllowDownFileExt yml
  Use SecAllowUpFileExt yml
 </LocationMatch>

 # Customer page
 <LocationMatch "^$frontPath/customer.pl">
  Use SecAllowExt "pl"
  Use SecRestrictUsername "user"
  Use SecBadAuth "Login failed"
  #Use SecArgNameAllowCharacter "][:#"
 </LocationMatch>

</Macro>

# The "appliance" version has fixed URL -> use the same ones
<Macro OTRS_appliance_ProxySSL @frontServer @backServer>
 # Main page
 RewriteRule "^/?$" "/otrs/customer.pl" [R,L,DPI]

 Use OTRS_ProxySSL @frontServer "/otrs" http @backServer 80 "/otrs"
 # For static resources JS, CSS, ...
 Use ProxySSL  @frontServer "/otrs-web" @backServer
 Use SecWebAppId OTRS

 <Location /otrs-web>
  Use SecStaticPages
 </Location>

 <LocationMatch "^/otrs-web/js/thirdparty/ckeditor-">
  Use SecAllowDotInUrl
 </LocationMatch>
</Macro>

